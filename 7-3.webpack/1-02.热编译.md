# çƒ­ç¼–è¯‘

> åœ¨å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆå°† [`mode` è®¾ç½®ä¸º `'development'`](https://v4.webpack.docschina.org/concepts/mode/#mode-development)ã€‚

åœ¨æ¯æ¬¡ç¼–è¯‘ä»£ç æ—¶ï¼Œæ‰‹åŠ¨è¿è¡Œ `npm run build` ä¼šæ˜¾å¾—å¾ˆéº»çƒ¦ï¼Œ`webpack` æä¾›å‡ ç§å¯é€‰æ–¹å¼ï¼Œå¸®åŠ©ä½ åœ¨ä»£ç å‘ç”Ÿå˜åŒ–åè‡ªåŠ¨ç¼–è¯‘ä»£ç ï¼š

1. `webpack watch mode`(`webpack` è§‚å¯Ÿæ¨¡å¼)
2. `webpack-dev-server`
3. `webpack-dev-middleware`

## watch mode

ä½ å¯ä»¥æŒ‡ç¤º ``webpack`` "``watch``" ä¾èµ–å›¾ä¸­æ‰€æœ‰æ–‡ä»¶çš„æ›´æ”¹ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶è¢«æ›´æ–°ï¼Œä»£ç å°†è¢«é‡æ–°ç¼–è¯‘ï¼Œæ‰€ä»¥ä½ ä¸å¿…å†å»æ‰‹åŠ¨è¿è¡Œæ•´ä¸ªæ„å»ºã€‚

æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç”¨äºå¯åŠ¨ ``webpack watch mode`` çš„ ``npm scripts``ï¼š

```diff
{
    "name": "development",
    "version": "1.0.0",
    "description": "",
    "main": "webpack.config.js",
    "scripts": {
      "test": "echo \"Error: no test specified\" && exit 1",
+     "watch": "webpack --watch",
      "build": "webpack"
    },
  }
```

è¿˜å¯ä»¥åœ¨ç¼–è¯‘é€‰é¡¹é‡Œæ·»åŠ ï¼š

```ts
module.export = {
    // é»˜è®¤false,ä¹Ÿå°±æ˜¯ä¸å¼€å¯
    watch: true,
    // åªæœ‰å¼€å¯ç›‘å¬æ¨¡å¼æ—¶ï¼ŒwatchOptionsæ‰æœ‰æ„ä¹‰
    watchOptions: {
        // é»˜è®¤ä¸ºç©ºï¼Œä¸ç›‘å¬çš„æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹ï¼Œæ”¯æŒæ­£åˆ™åŒ¹é…
        ignored: /node_modules/,
        // ç›‘å¬åˆ°å˜åŒ–å‘ç”Ÿåä¼šç­‰300mså†å»æ‰§è¡Œï¼Œé»˜è®¤300ms
        aggregateTimeout:300,
        // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–æ˜¯é€šè¿‡ä¸åœè¯¢é—®ç³»ç»ŸæŒ‡å®šæ–‡ä»¶æœ‰æ²¡æœ‰å˜åŒ–å®ç°çš„ï¼Œé»˜è®¤æ¯ç§’é—®1000æ¬¡
        poll:1000
    }
}
```

### åŸç†

è½®è¯¢åˆ¤æ–­æ–‡ä»¶çš„æœ€åç¼–è¾‘æ—¶é—´æ˜¯å¦å˜åŒ–ï¼Œå¦‚æœæŸä¸ªæ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼Œå¹¶ä¸ä¼šç«‹åˆ»å‘Šè¯‰ç›‘å¬è€…ï¼Œè€Œæ˜¯å…ˆç¼“å­˜èµ·æ¥ï¼Œç­‰ `aggregateTimeout` åå†æ‰§è¡Œç¼–è¯‘ã€‚

å”¯ä¸€çš„ç¼ºç‚¹æ˜¯ï¼Œä¸ºäº†çœ‹åˆ°ä¿®æ”¹åçš„å®é™…æ•ˆæœï¼Œä½ éœ€è¦åˆ·æ–°æµè§ˆå™¨ã€‚å¦‚æœèƒ½å¤Ÿè‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨å°±æ›´å¥½äº†ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå°è¯•é€šè¿‡ `webpack-dev-server` å®ç°æ­¤åŠŸèƒ½ã€‚



# çƒ­æ›´æ–°

`Webpack` çš„çƒ­æ›´æ–°åˆç§°çƒ­æ›¿æ¢ï¼ˆ`Hot Module Replacement`ï¼‰ï¼Œç¼©å†™ä¸º `HMR`ã€‚ è¿™ä¸ªæœºåˆ¶å¯ä»¥åšåˆ°ä¸ç”¨åˆ·æ–°æµè§ˆå™¨è€Œå°†æ–°å˜æ›´çš„æ¨¡å—æ›¿æ¢æ‰æ—§çš„æ¨¡å—ã€‚

`HMR`çš„æ ¸å¿ƒå°±æ˜¯å®¢æˆ·ç«¯ä»æœåŠ¡ç«¯æ‹‰å»æ›´æ–°åçš„æ–‡ä»¶ï¼Œå‡†ç¡®çš„è¯´æ˜¯ `chunk diff (chunk` éœ€è¦æ›´æ–°çš„éƒ¨åˆ†)ï¼Œå®é™…ä¸Š `WDS` ä¸æµè§ˆå™¨ä¹‹é—´ç»´æŠ¤äº†ä¸€ä¸ª `Websocket`ï¼Œå½“æœ¬åœ°èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`WDS` ä¼šå‘æµè§ˆå™¨æ¨é€æ›´æ–°ï¼Œå¹¶å¸¦ä¸Šæ„å»ºæ—¶çš„ `hash`ï¼Œè®©å®¢æˆ·ç«¯ä¸ä¸Šä¸€æ¬¡èµ„æºè¿›è¡Œå¯¹æ¯”ã€‚

å®¢æˆ·ç«¯å¯¹æ¯”å‡ºå·®å¼‚åä¼šå‘ `WDS` å‘èµ· `Ajax` è¯·æ±‚æ¥è·å–æ›´æ”¹å†…å®¹(æ–‡ä»¶åˆ—è¡¨ã€`hash)`ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥å†å€ŸåŠ©è¿™äº›ä¿¡æ¯ç»§ç»­å‘ `WDS` å‘èµ· `jsonp` è¯·æ±‚è·å–è¯¥`chunk`çš„å¢é‡æ›´æ–°ã€‚

## webpack-dev-server

`webpack-dev-server` ä¸ºä½ æä¾›äº†ä¸€ä¸ªç®€å•çš„ `web server`ï¼Œå¹¶ä¸”å…·æœ‰ `live reloading`(å®æ—¶é‡æ–°åŠ è½½) åŠŸèƒ½ã€‚è®¾ç½®å¦‚ä¸‹ï¼š

```bash
npm install --save-dev webpack-dev-server
```

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®¾ç½® `dev server`æ ¹ç›®å½•ä½ç½®ï¼š

```diff
  const path = require('path');
  const HtmlWebpackPlugin = require('html-webpack-plugin');
  const CleanWebpackPlugin = require('clean-webpack-plugin');

  module.exports = {
    mode: 'development',
    entry: {
      app: './src/index.js',
      print: './src/print.js'
    },
    devtool: 'inline-source-map',
+   devServer: {
+     contentBase: './dist'
+   },
    plugins: [
      new CleanWebpackPlugin(['dist']),
      new HtmlWebpackPlugin({
        title: 'Development'
      })
    ],
    output: {
      filename: '[name].bundle.js',
      path: path.resolve(__dirname, 'dist')
    }
  };
```

ä»¥ä¸Šé…ç½®å‘ŠçŸ¥ `webpack-dev-server`ï¼Œå°† `dist` ç›®å½•ä¸‹çš„æ–‡ä»¶ serve åˆ° `localhost:8080` ä¸‹ã€‚

> webpack-dev-server åœ¨ç¼–è¯‘ä¹‹åä¸ä¼šå†™å…¥åˆ°ä»»ä½•è¾“å‡ºæ–‡ä»¶ã€‚è€Œæ˜¯å°† bundle æ–‡ä»¶ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œç„¶åå°†å®ƒä»¬ serve åˆ° server ä¸­ï¼Œå°±å¥½åƒå®ƒä»¬æ˜¯æŒ‚è½½åœ¨ server æ ¹è·¯å¾„ä¸Šçš„çœŸå®æ–‡ä»¶ä¸€æ ·ã€‚å¦‚æœä½ çš„é¡µé¢å¸Œæœ›åœ¨å…¶ä»–ä¸åŒè·¯å¾„ä¸­æ‰¾åˆ° bundle æ–‡ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡ dev server é…ç½®ä¸­çš„ [`publicPath`](https://v4.webpack.docschina.org/configuration/dev-server/#devserver-publicpath-) é€‰é¡¹è¿›è¡Œä¿®æ”¹ã€‚

æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œ dev server çš„ scriptï¼š

**package.json**

```diff
  {
    "name": "development",
    "version": "1.0.0",
    "description": "",
    "main": "webpack.config.js",
    "scripts": {
      "test": "echo \"Error: no test specified\" && exit 1",
      "watch": "webpack --watch",
+     "start": "webpack-dev-server --open",
      "build": "webpack"
    }
  }
```

ç°åœ¨ï¼Œåœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ `npm start`ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æµè§ˆå™¨è‡ªåŠ¨åŠ è½½é¡µé¢ã€‚å¦‚æœä½ æ›´æ”¹ä»»ä½•æºæ–‡ä»¶å¹¶ä¿å­˜å®ƒä»¬ï¼Œweb server å°†åœ¨ç¼–è¯‘ä»£ç åè‡ªåŠ¨é‡æ–°åŠ è½½ã€‚è¯•è¯•çœ‹ï¼

### åŸç†

`webpackCompilerï¼ˆwebpackç¼–è¯‘å™¨ï¼‰`ç¼–è¯‘æ–‡ä»¶ä¹‹åï¼Œ`buddule-server`æä¾›ä¸€ä¸ªç›®å½•çš„è®¿é—®ã€‚`hmr-server`åˆ›å»ºä¸€ä¸ª`websocket`ï¼Œä»£ç æ”¹å˜æ—¶ï¼Œæ‰“åŒ…ç¼–è¯‘å™¨é€šçŸ¥`hmr-server`ï¼Œ`hmr-server`å‘é€æ›´æ–°`json`ç»™`hmr-rutime`ï¼Œ`runtime`è¿›è¡Œå®æ—¶æ›´æ–°ã€‚

<img src="assets/image-20210116145032569.png" alt="image-20210116145032569" style="zoom:30%;" />

### é…ç½®æ‹“å±•

#### `devServer.publicPath`

ç”¨äºè®¾ç½®æ‰“åŒ…æ–‡ä»¶åœ¨æµè§ˆå™¨ä¸­çš„è®¿é—®å‰ç¼€ï¼Œå‡è®¾æœåŠ¡å™¨è¿è¡Œåœ¨ `http://localhost:8080` å¹¶ä¸” [`output.filename`](https://v4.webpack.docschina.org/configuration/output/#output-filename) è¢«è®¾ç½®ä¸º `bundle.js`ã€‚é»˜è®¤ `devServer.publicPath` æ˜¯ `'/'`ï¼Œæ‰€ä»¥ä½ çš„åŒ…(bundle)å¯ä»¥é€šè¿‡ `http://localhost:8080/bundle.js` è®¿é—®ã€‚

ä¿®æ”¹ `devServer.publicPath`ï¼Œå°† bundle æ”¾åœ¨æŒ‡å®šç›®å½•ä¸‹ï¼š

**webpack.config.js**

```javascript
module.exports = {
  //...
  devServer: {
    publicPath: '/assets/'
  }
};
```

ç°åœ¨å¯ä»¥é€šè¿‡ `http://localhost:8080/assets/bundle.js` è®¿é—® bundleã€‚

> ç¡®ä¿ `devServer.publicPath` æ€»æ˜¯ä»¥æ–œæ (/)å¼€å¤´å’Œç»“å°¾ã€‚

#### `devServer.port`

æŒ‡å®šè¦ç›‘å¬è¯·æ±‚çš„ç«¯å£å·ï¼š

**webpack.config.js**

```javascript
module.exports = {
  //...
  devServer: {
    port: 8080
  }
};
```

CLI ç”¨æ³•

```bash
webpack-dev-server --port 8080
```

#### `devServer.lazy` ğŸ”‘

å½“å¯ç”¨ `devServer.lazy` æ—¶ï¼Œdev-server åªæœ‰åœ¨è¯·æ±‚æ—¶æ‰ç¼–è¯‘åŒ…(bundle)ã€‚è¿™æ„å‘³ç€ webpack ä¸ä¼šç›‘è§†ä»»ä½•æ–‡ä»¶æ”¹åŠ¨ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º**æƒ°æ€§æ¨¡å¼**ã€‚

**webpack.config.js**

```javascript
module.exports = {
  //...
  devServer: {
    lazy: true
  }
};
```

#### `devServer.filename` ğŸ”‘

åœ¨ [lazy mode(æƒ°æ€§æ¨¡å¼)](https://v4.webpack.docschina.org/configuration/dev-server/#devserver-lazy-) ä¸­ï¼Œæ­¤é€‰é¡¹å¯å‡å°‘ç¼–è¯‘ã€‚ é»˜è®¤åœ¨ [lazy mode(æƒ°æ€§æ¨¡å¼)](https://v4.webpack.docschina.org/configuration/dev-server/#devserver-lazy-)ï¼Œæ¯ä¸ªè¯·æ±‚ç»“æœéƒ½ä¼šäº§ç”Ÿå…¨æ–°çš„ç¼–è¯‘ã€‚ä½¿ç”¨ `filename`ï¼Œå¯ä»¥åªåœ¨æŸä¸ªæ–‡ä»¶è¢«è¯·æ±‚æ—¶ç¼–è¯‘ã€‚

å¦‚æœ [`output.filename`](https://v4.webpack.docschina.org/configuration/output/#output-filename) è®¾ç½®ä¸º `'bundle.js'` ï¼Œ`devServer.filename` ç”¨æ³•å¦‚ä¸‹ï¼š

**webpack.config.js**

```javascript
module.exports = {
  //...
  output: {
    filename: 'bundle.js'
  },
  devServer: {
    lazy: true,
    filename: 'bundle.js'
  }
};
```

ç°åœ¨åªæœ‰åœ¨è¯·æ±‚ `/bundle.js` æ—¶å€™ï¼Œæ‰ä¼šç¼–è¯‘ bundleã€‚

#### `devServer.headers` ğŸ”‘

åœ¨æ‰€æœ‰å“åº”ä¸­æ·»åŠ é¦–éƒ¨å†…å®¹ï¼š

**webpack.config.js**

```javascript
module.exports = {
  //...
  devServer: {
    headers: {
      'X-Custom-Foo': 'bar'
    }
  }
};
```

#### `devServer.historyApiFallback`

å½“ä½¿ç”¨ [HTML5 History API](https://developer.mozilla.org/en-US/docs/Web/API/History) æ—¶ï¼Œä»»æ„çš„ `404` å“åº”éƒ½å¯èƒ½éœ€è¦è¢«æ›¿ä»£ä¸º `index.html`ã€‚`devServer.historyApiFallback` é»˜è®¤ç¦ç”¨ã€‚é€šè¿‡ä¼ å…¥ä»¥ä¸‹å¯ç”¨ï¼š

**webpack.config.js**

```javascript
module.exports = {
  //...
  devServer: {
    historyApiFallback: true
  }
};
```

#### `devServer.hot`

å¯ç”¨ webpack çš„ [æ¨¡å—çƒ­æ›¿æ¢](https://v4.webpack.docschina.org/concepts/hot-module-replacement/) åŠŸèƒ½ï¼š

**webpack.config.js**

```javascript
module.exports = {
  //...
  devServer: {
    hot: true
  }
};
```

> æ³¨æ„ï¼Œå¿…é¡»æœ‰ [`webpack.HotModuleReplacementPlugin`](https://v4.webpack.docschina.org/plugins/hot-module-replacement-plugin/) æ‰èƒ½å®Œå…¨å¯ç”¨ HMRã€‚å¦‚æœ `webpack` æˆ– `webpack-dev-server` æ˜¯é€šè¿‡ `--hot` é€‰é¡¹å¯åŠ¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ’ä»¶ä¼šè¢«è‡ªåŠ¨æ·»åŠ ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¸éœ€è¦æŠŠå®ƒæ·»åŠ åˆ° `webpack.config.js` ä¸­ã€‚å…³äºæ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [HMR æ¦‚å¿µ](https://v4.webpack.docschina.org/concepts/hot-module-replacement/) é¡µé¢ã€‚