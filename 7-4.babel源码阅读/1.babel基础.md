# Babel

`Babel` æ˜¯ä¸€ä¸ªå·¥å…·é“¾ï¼Œä¸»è¦ç”¨äºå°† `ECMAScript 2015`+ ç‰ˆæœ¬çš„ä»£ç è½¬æ¢ä¸ºå‘åå…¼å®¹çš„ `JavaScript` è¯­æ³•ï¼Œä»¥ä¾¿èƒ½å¤Ÿè¿è¡Œåœ¨å½“å‰å’Œæ—§ç‰ˆæœ¬çš„æµè§ˆå™¨æˆ–å…¶ä»–ç¯å¢ƒä¸­ã€‚ä¸‹é¢åˆ—å‡ºçš„æ˜¯ `Babel` èƒ½ä¸ºä½ åšçš„äº‹æƒ…ï¼š

+ è¯­æ³•è½¬æ¢ï¼š`ES6 > ES5`
+ æ‰“è¡¥ä¸ï¼šé€šè¿‡ `Polyfill` æ–¹å¼åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ·»åŠ ç¼ºå¤±çš„ç‰¹æ€§ (é€šè¿‡ [@babel/polyfill](https://www.babeljs.cn/docs/babel-polyfill) æ¨¡å—)
+ æºç è½¬æ¢ï¼š`ts > js`

```js
// Babel è¾“å…¥ï¼š ES2015 ç®­å¤´å‡½æ•°
[1, 2, 3].map((n) => n + 1);

// Babel è¾“å‡ºï¼š ES5 è¯­æ³•å®ç°çš„åŒç­‰åŠŸèƒ½
[1, 2, 3].map(function(n) {
  return n + 1;
});
```

## åŸºæœ¬æ¶æ„

ä½ æ‰€éœ€è¦çš„æ‰€æœ‰çš„ `Babel` æ¨¡å—éƒ½æ˜¯ä½œä¸ºç‹¬ç«‹çš„ `npm` åŒ…å‘å¸ƒçš„ï¼Œå¹¶ä¸”ï¼ˆä»ç‰ˆæœ¬ `7` å¼€å§‹ï¼‰éƒ½æ˜¯ä»¥ `@babel` ä½œä¸ºå† åçš„ã€‚è¿™ç§æ¨¡å—åŒ–çš„è®¾è®¡èƒ½å¤Ÿè®©æ¯ç§å·¥å…·éƒ½é’ˆå¯¹ç‰¹å®šä½¿ç”¨æƒ…å†µè¿›è¡Œè®¾è®¡ã€‚ ä¸‹é¢æˆ‘ä»¬ç€é‡çœ‹ä¸€ä¸‹ `@babel/core` å’Œ `@babel/cli`ã€‚

### æ ¸å¿ƒåº“

Babel çš„æ ¸å¿ƒåŠŸèƒ½åŒ…å«åœ¨ [@babel/core](https://www.babeljs.cn/docs/babel-core) æ¨¡å—ä¸­ã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š

```sh
npm install --save-dev @babel/core
```

ä½ å¯ä»¥åœ¨ JavaScript ç¨‹åºä¸­ç›´æ¥ `require` å¹¶ä½¿ç”¨å®ƒï¼š

```js
const babel = require("@babel/core");

babel.transform("code", optionsObject);
```

ä½œä¸ºä¸€åæœ€ç»ˆç”¨æˆ·ï¼Œä½ å¯ä»¥è¿˜éœ€è¦å®‰è£…å…¶ä»–å·¥å…·ä½œä¸º `@babel/core` çš„ä½¿ç”¨æ¥å£å¹¶å¾ˆå¥½åœ°é›†æˆåˆ°ä½ çš„å¼€å‘æµç¨‹ä¸­ã€‚å³ä¾¿å¦‚æ­¤ï¼Œä½ ä»ç„¶éœ€è¦æŸ¥çœ‹å…¶æ–‡æ¡£å¹¶äº†è§£å¯ç”¨çš„å‚æ•°ï¼Œå…¶ä¸­å¾ˆå¤šå‚æ•°ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–å·¥å…·è¿›è¡Œè®¾ç½®ã€‚

### CLI å‘½ä»¤è¡Œå·¥å…·

[@babel/cli](https://www.babeljs.cn/docs/babel-cli) æ˜¯ä¸€ä¸ªèƒ½å¤Ÿä»ç»ˆç«¯ï¼ˆå‘½ä»¤è¡Œï¼‰ä½¿ç”¨çš„å·¥å…·ã€‚ä¸‹é¢æ˜¯å…¶å®‰è£…å‘½ä»¤å’ŒåŸºæœ¬ç”¨æ³•ï¼š

```sh
npm install --save-dev @babel/core @babel/cli

> ./node_modules/.bin/babel src --out-dir lib
```

è¿™å°†è§£æ `src` ç›®å½•ä¸‹çš„æ‰€æœ‰ JavaScript æ–‡ä»¶ï¼Œå¹¶åº”ç”¨æˆ‘ä»¬æ‰€æŒ‡å®šçš„ä»£ç è½¬æ¢åŠŸèƒ½ï¼Œç„¶åæŠŠæ¯ä¸ªæ–‡ä»¶è¾“å‡ºåˆ° `lib` ç›®å½•ä¸‹ã€‚ç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰æŒ‡å®šä»»ä½•ä»£ç è½¬æ¢åŠŸèƒ½ï¼Œæ‰€ä»¥è¾“å‡ºçš„ä»£ç å°†ä¸è¾“å…¥çš„ä»£ç ç›¸åŒï¼ˆä¸ä¿ç•™åŸä»£ç æ ¼å¼ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥å°†æˆ‘ä»¬æ‰€éœ€è¦çš„ä»£ç è½¬æ¢åŠŸèƒ½ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚

ä¸Šé¢çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº† `--out-dir` å‚æ•°ã€‚ä½ å¯ä»¥é€šè¿‡ `--help` å‚æ•°æ¥æŸ¥çœ‹å‘½ä»¤è¡Œå·¥å…·æ‰€èƒ½æ¥å—çš„æ‰€æœ‰å‚æ•°åˆ—è¡¨ã€‚ä½†æ˜¯ç°åœ¨å¯¹æˆ‘ä»¬æ¥è¯´æœ€é‡è¦çš„æ˜¯ `--plugins` å’Œ `--presets` è¿™ä¸¤ä¸ªå‚æ•°ã€‚

æ­¤å¤–è¿˜æœ‰ `npx` çš„æ–¹å¼ï¼š

```bash
npx babel script.js
```

å¦‚æœä½ å¸Œæœ› **è¾“å‡ºåˆ°æ–‡ä»¶** ï¼Œå¯ä»¥ä½¿ç”¨ `--out-file` æˆ– `-o` å‚æ•°ã€‚

```sh
npx babel script.js --out-file script-compiled.js
```

è¦åœ¨ **æ¯æ¬¡æ–‡ä»¶ä¿®æ”¹å** ç¼–è¯‘è¯¥æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ `--watch` æˆ– `-w` å‚æ•°ï¼š

```sh
npx babel script.js --watch --out-file script-compiled.js
```

å¦‚æœä½ å¸Œæœ›è¾“å‡º **æºç æ˜ å°„è¡¨ï¼ˆsource mapï¼‰æ–‡ä»¶** ï¼Œä½ å¯ä»¥ä½¿ç”¨ `--source-maps` æˆ– `-s` å‚æ•°ã€‚[äº†è§£æ›´å¤šæœ‰å…³æºç æ˜ å°„è¡¨ï¼ˆsource mapï¼‰çš„ä¿¡æ¯](http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/)ã€‚

```sh
npx babel script.js --out-file script-compiled.js --source-maps
```

ç¼–è¯‘æ•´ä¸ª `src` ç›®å½•ä¸‹çš„æ–‡ä»¶å¹¶è¾“å‡ºåˆ° `lib` ç›®å½•ï¼Œè¾“å‡ºç›®å½•å¯ä»¥é€šè¿‡ `--out-dir` æˆ– `-d` æŒ‡å®šã€‚è¿™ä¸ä¼šè¦†ç›– `lib` ç›®å½•ä¸‹çš„ä»»ä½•å…¶ä»–æ–‡ä»¶æˆ–ç›®å½•ã€‚

```sh
npx babel src --out-dir lib
```

ç¼–è¯‘æ•´ä¸ª `src` ç›®å½•ä¸‹çš„æ–‡ä»¶å¹¶å°†è¾“å‡ºåˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚

```sh
npx babel src --out-file script-compiled.js
```

å¿½ç•¥è§„èŒƒå’Œæµ‹è¯•æ–‡ä»¶

```sh
npx babel src --out-dir lib --ignore "src/**/*.spec.js","src/**/*.test.js"
```

## æ’ä»¶å’Œé¢„è®¾

### æ’ä»¶

ä»£ç è½¬æ¢åŠŸèƒ½ä»¥æ’ä»¶çš„å½¢å¼å‡ºç°ï¼Œæ’ä»¶æ˜¯å°å‹çš„ `JavaScript` ç¨‹åºï¼Œç”¨äºæŒ‡å¯¼ `Babel` å¦‚ä½•å¯¹ä»£ç è¿›è¡Œè½¬æ¢ã€‚ä½ ç”šè‡³å¯ä»¥ç¼–å†™è‡ªå·±çš„æ’ä»¶å°†ä½ æ‰€éœ€è¦çš„ä»»ä½•ä»£ç è½¬æ¢åŠŸèƒ½åº”ç”¨åˆ°ä½ çš„ä»£ç ä¸Šã€‚

æ¯”å¦‚ä¸‹é¢çš„ç®­å¤´å‡½æ•°è½¬æ¢æ’ä»¶ï¼š

```shell
npm install --save-dev @babel/plugin-transform-arrow-functions

./node_modules/.bin/babel src --out-dir lib --plugins=@babel/plugin-transform-arrow-functions
```

### é¢„è®¾

ä½†æ˜¯æˆ‘ä»¬çš„ä»£ç ä¸­ä»ç„¶æ®‹ç•™äº†å…¶ä»– `ES2015`+ çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹å®ƒä»¬ä¹Ÿè¿›è¡Œè½¬æ¢ã€‚æˆ‘ä»¬ä¸éœ€è¦ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ·»åŠ æ‰€æœ‰éœ€è¦çš„æ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª "`preset`" ï¼ˆå³ä¸€ç»„é¢„å…ˆè®¾å®šçš„æ’ä»¶ï¼‰ã€‚

å°±åƒæ’ä»¶ä¸€æ ·ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±æ‰€éœ€è¦çš„æ’ä»¶ç»„åˆåˆ›å»ºä¸€ä¸ªè‡ªå·±çš„ `preset` å¹¶å°†å…¶åˆ†äº«å‡ºå»ã€‚å¯¹äºå½“å‰çš„ç”¨ä¾‹è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåç§°ä¸º `env` çš„ `preset`ã€‚

```shell
npm install --save-dev @babel/preset-env

./node_modules/.bin/babel src --out-dir lib --presets=@babel/env
```

å¦‚æœä¸è¿›è¡Œä»»ä½•é…ç½®ï¼Œä¸Šè¿° `preset` æ‰€åŒ…å«çš„æ’ä»¶å°†æ”¯æŒæ‰€æœ‰æœ€æ–°çš„ `JavaScript` ï¼ˆ`ES2015`ã€`ES2016` ç­‰ï¼‰ç‰¹æ€§ã€‚ä½†æ˜¯ `preset` ä¹Ÿæ˜¯æ”¯æŒå‚æ•°çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å¦ä¸€ç§ä¼ é€’å‚æ•°çš„æ–¹æ³•ï¼šé…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯é€šè¿‡ç»ˆç«¯æ§åˆ¶å°åŒæ—¶ä¼ é€’ `cli` å’Œ `preset` çš„å‚æ•°ã€‚

## Polyfill

`Polyfill` æ˜¯ä¸€å—ä»£ç ï¼ˆé€šå¸¸æ˜¯ `Web` ä¸Šçš„ `JavaScript`ï¼‰ï¼Œç”¨æ¥ä¸ºæ—§æµè§ˆå™¨æä¾›å®ƒæ²¡æœ‰åŸç”Ÿæ”¯æŒçš„è¾ƒæ–°çš„åŠŸèƒ½ã€‚

[@babel/polyfill](https://www.babeljs.cn/docs/babel-polyfill) æ¨¡å—åŒ…å« [core-js](https://github.com/zloirock/core-js) å’Œä¸€ä¸ªè‡ªå®šä¹‰çš„ [regenerator runtime](https://github.com/facebook/regenerator/blob/master/packages/regenerator-runtime/runtime.js) æ¥æ¨¡æ‹Ÿå®Œæ•´çš„ ES2015+ ç¯å¢ƒã€‚

> `Core-js` åŒ…å«äº†å‡ ä¹æ‰€æœ‰çš„å®˜æ–¹  `es5+ api` çš„ `polefill` ä»£ç ã€‚
>
> `regenerator` åˆ™ç”¨äº `generator functions` çš„å…¼å®¹ã€‚

è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨è¯¸å¦‚ `Promise` å’Œ `WeakMap` ä¹‹ç±»çš„æ–°çš„å†…ç½®ç»„ä»¶ã€ `Array.from` æˆ– `Object.assign` ä¹‹ç±»çš„é™æ€æ–¹æ³•ã€ `Array.prototype.includes` ä¹‹ç±»çš„å®ä¾‹æ–¹æ³•ä»¥åŠç”Ÿæˆå™¨å‡½æ•°ï¼ˆ``generator functions``ï¼‰ï¼ˆå‰ææ˜¯ä½ ä½¿ç”¨äº† ``regenerator`` æ’ä»¶ï¼‰ã€‚

```bash
npm install --save @babel/polyfill
```

> æ³¨æ„ï¼Œä½¿ç”¨ `--save` å‚æ•°è€Œä¸æ˜¯ `--save-dev`ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªéœ€è¦åœ¨ä½ çš„æºç ä¹‹å‰è¿è¡Œçš„ polyfillã€‚

`@babel/polyfill` å¯ä»¥é€šè¿‡ç›´æ¥å¼•å…¥çš„æ–¹å¼è¿›å…¥å…¨å±€ç¯å¢ƒï¼š

```js
import "@babel/polyfill"
```

ç”±äºä»£ç åŒ…è¾ƒå¤§ï¼Œè¿™é‡Œæ¨èæŒ‰éœ€å¼•å…¥ `useBuiltIns`ï¼Œæ­¤å¤–æˆ‘ä»¬è¿˜å®šåˆ¶äº†è¾¹ç¼˜æµè§ˆå™¨çš„ç‰ˆæœ¬ `targets`ï¼š

```js
{
  "presets": [
    [
      "@babel/env",
      {
        "useBuiltIns": "usage",
        "corejs": 3,
				"targets": {
          "edge": "17",
          "firefox": "60",
          "chrome": "67",
          "safari": "11.1",
        },
      }
    ]
  ]
}
```

Babel å°†æ£€æŸ¥ä½ çš„æ‰€æœ‰ä»£ç ï¼Œä»¥ä¾¿æŸ¥æ‰¾ç›®æ ‡ç¯å¢ƒä¸­ç¼ºå¤±çš„åŠŸèƒ½ï¼Œç„¶ååªæŠŠå¿…é¡»çš„ polyfill åŒ…å«è¿›æ¥ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```js
Promise.resolve().finally();
```

å°†è¢«è½¬æ¢ä¸ºï¼ˆç”±äº Edge 17 æ²¡æœ‰ `Promise.prototype.finally`ï¼‰ï¼š

```js
require("core-js/modules/es.promise.finally");

Promise.resolve().finally();
```

ä¸ºäº†æ·»åŠ è¿™äº›åŠŸèƒ½ï¼Œpolyfill å°†æ·»åŠ åˆ°å…¨å±€èŒƒå›´ï¼ˆglobal scopeï¼‰å’Œç±»ä¼¼ `String` è¿™æ ·çš„åŸç”ŸåŸå‹ï¼ˆnative prototypesï¼‰ä¸­ã€‚å¯¹äºè½¯ä»¶åº“/å·¥å…·çš„ä½œè€…æ¥è¯´ï¼Œè¿™å¯èƒ½å¤ªå¤šäº†ã€‚å¦‚æœä½ ä¸éœ€è¦ç±»ä¼¼ `Array.prototype.includes` çš„å®ä¾‹æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ [transform runtime](https://www.babeljs.cn/docs/babel-plugin-transform-runtime) æ’ä»¶è€Œä¸æ˜¯å¯¹å…¨å±€èŒƒå›´ï¼ˆglobal scopeï¼‰é€ æˆæ±¡æŸ“çš„ `@babel/polyfill`ã€‚

> ğŸš¨ ä» Babel 7.4.0 ç‰ˆæœ¬å¼€å§‹ï¼Œè¿™ä¸ªè½¯ä»¶åŒ…å·²ç»ä¸å»ºè®®ä½¿ç”¨äº†ï¼Œå»ºè®®ç›´æ¥åŒ…å« `core-js/stable` ï¼ˆç”¨äºæ¨¡æ‹Ÿ ECMAScript çš„åŠŸèƒ½ï¼‰å’Œ `regenerator-runtime/runtime` ï¼ˆéœ€è¦ä½¿ç”¨è½¬è¯‘åçš„ç”Ÿæˆå™¨å‡½æ•°ï¼‰ï¼š
>
> ```js
> import "core-js/stable";
> import "regenerator-runtime/runtime";
> ```

## é…ç½®

ç°åœ¨ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º `babel.config.json` çš„æ–‡ä»¶ï¼ˆéœ€è¦ `v7.8.0` æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰ï¼Œå¹¶åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š

```json
{
    "presets": [
        [
            "@babel/preset-env",
            {
                "useBuiltIns": "usage",
                "corejs": 3,
                "targets": {
                    "edge": "17",
                    "firefox": "60",
                    "chrome": "67",
                    "safari": "11.1"
                }
            }
        ],
        "@babel/preset-react"
    ],
    "plugins": []
}

```

### å¸¸ç”¨é…ç½®

`babel` ä¸»è¦æœ‰å¦‚ä¸‹å››ä¸ªé…ç½® `es5+`ã€`flow`ã€`typescript`ã€`react`ï¼š

+ `typescript`ï¼š`@babel/preset-typescript`ï¼›
+ `es5+`ï¼š`@babel/preset-env`ï¼›
+ `react`ï¼š`@babel/preset-react`ï¼›

### ç”¨ JavaScript ç¼–å†™é…ç½®æ–‡ä»¶

ä½ è¿˜å¯ä»¥ç”¨ JavaScript ç¼–å†™ `babel.config.json` å’Œ `.babelrc.json`æ–‡ä»¶ï¼š

```js
const presets = [ ... ];
const plugins = [ ... ];

module.exports = { presets, plugins };
```

ä½ è¿˜å¯ä»¥è°ƒç”¨ Node.js çš„ä»»ä½• APIï¼Œä¾‹å¦‚åŸºäºè¿›ç¨‹ç¯å¢ƒè¿›è¡ŒåŠ¨æ€é…ç½®ï¼š

```js
const presets = [ ... ];
const plugins = [ ... ];

if (process.env["ENV"] === "prod") {
  plugins.push(...);
}

module.exports = { presets, plugins };
```

#### Preset çš„å‚æ•°

æ’ä»¶å’Œ preset éƒ½å¯ä»¥æ¥å—å‚æ•°ï¼Œå‚æ•°ç”±æ’ä»¶åå’Œå‚æ•°å¯¹è±¡ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ã€‚

å¦‚æœä¸æŒ‡å®šå‚æ•°ï¼Œä¸‹é¢è¿™å‡ ç§å½¢å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼š

```json
{
  "presets": [
    "presetA",
    ["presetA"],
    ["presetA", {}],
  ]
}
```

è¦æŒ‡å®šå‚æ•°ï¼Œè¯·ä¼ é€’ä¸€ä¸ªä»¥å‚æ•°åä½œä¸ºé”®ï¼ˆkeyï¼‰çš„å¯¹è±¡ã€‚

```json
{
  "presets": [
    ["@babel/preset-env", {
      "loose": true,
      "modules": false
    }]
  ]
}
```

## ğŸŒ°

å‡è®¾æˆ‘ä»¬ç°åœ¨å·²ç»é…ç½®äº† `es5+`ã€`react`ã€`polefill` ï¼š

```js
Promise.then(() => {});
[(1, 2, 3, 5)].indexOf(1);

class Btn extends React.Component {
    render() {
        return <div></div>;
    }
}
```

ä¸Šé¢è¿™æ®µä»£ç ä¼šè¢«è¿›è¡Œå¦‚ä¸‹è½¬åŒ–ï¼š

```js
"use strict";

require("core-js/modules/es.promise.js"); 

Promise.then(function() {});
[(1, 2, 3, 5)].indexOf(1);

class Btn extends React.Component {
  render() {
    return /*#__PURE__*/React.createElement("div", null);
  }

}
```

é¦–å…ˆï¼ŒæŒ‰éœ€å¯¼å…¥ `Promise`ï¼Œä¹‹åç¼–è¯‘ `jsx`ã€‚æ³¨æ„ `babel` åšçš„åªæ˜¯è¯­æ³•ç¼–è¯‘ï¼Œè€Œæ¨¡å—åŒ–çš„åŠŸèƒ½è¿˜æ˜¯ç”± `webpack` æ¥å®Œæˆçš„ã€‚