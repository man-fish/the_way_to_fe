# Asynchronous actions

- `flow` **annotation**
- `flow(function* (args) { })`
- `async action(fn)`

ä»æœ¬è´¨ä¸Šè¯´ï¼Œ`MobX` ä¸­çš„å¼‚æ­¥è¿‡ç¨‹ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºæ‰€æœ‰ `reaction` éƒ½æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„(ä¸å¼‚æ­¥è¿”å›çš„æ—¶é—´ç‚¹æ— å…³)ï¼Œä¸è¿‡åœ¨å¼‚æ­¥æµç¨‹ä¸­æ›´æ–°å¯è§‚å¯Ÿå¯¹è±¡çš„æ¯ä¸ªæ­¥éª¤éƒ½åº”è¯¥æ ‡è®°ä¸º `action`ã€‚

è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡å¤šç§æ–¹æ¡ˆå®ç°ã€‚

## Still use Action

é¦–å…ˆæ¥çœ‹çœ‹ä»ç„¶ä½¿ç”¨ `action` çš„ä¾‹å­ï¼Œè¿™ç§å†™æ³•ä¸èƒ½å¾ˆå¥½çš„æ ‡è®°å¼‚æ­¥ `action`ï¼š

### Wrap handlers in `action`

è¿™æ˜¯æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œç»™éœ€è¦æ›´æ”¹å¯è§‚å¯Ÿå¯¹è±¡çš„ `promise` å¤„ç†å™¨åŒ…è£¹ `action`ï¼š

```ts
import { action, makeAutoObservable } from "mobx"

class Store {
    githubProjects = []
    state = "pending" // "pending", "done" or "error"

    constructor() {
        makeAutoObservable(this)
    }

    fetchProjects() {
        this.githubProjects = []
        this.state = "pending"
        fetchGithubProjectsSomehow().then(
            action("fetchSuccess", projects => {
                const filteredProjects = somePreprocessing(projects)
                this.githubProjects = filteredProjects
                this.state = "done"
            }),
            action("fetchError", error => {
                this.state = "error"
            })
        )
    }
}
```

### async/await + runInAction

å¯¹äº `async/await` çš„å½¢å¼ï¼Œä½¿ç”¨ `runInAction`åŒ…è£¹æ‰§è¡Œæ‰§è¡Œæ›´æ–°çš„æ“ä½œï¼š

```ts
import { runInAction, makeAutoObservable } from "mobx"

class Store {
    githubProjects = []
    state = "pending" // "pending", "done" or "error"

    constructor() {
        makeAutoObservable(this)
    }

    async fetchProjects() {
        this.githubProjects = []
        this.state = "pending"
        try {
            const projects = await fetchGithubProjectsSomehow()
            const filteredProjects = somePreprocessing(projects)
            runInAction(() => {
                this.githubProjects = filteredProjects
                this.state = "done"
            })
        } catch (e) {
            runInAction(() => {
                this.state = "error"
            })
        }
    }
}
```

## Using flow instead of async / await {ğŸš€}

`makeautoobserve` å’Œç±»ä¼¼ `api`ï¼Œè‡ªåŠ¨æ¨æ–­ç”Ÿæˆå™¨ä¸ºæµç±»å‹ã€‚æµæ³¨è§£æˆå‘˜å°†æ˜¯**ä¸å¯æšä¸¾çš„**ã€‚

æµåŒ…è£…å™¨æ˜¯ `async / await` çš„ä¸€ä¸ªå¯é€‰æ›¿ä»£æ–¹æ¡ˆï¼Œå®ƒä½¿ `MobX` æ“ä½œæ›´å®¹æ˜“ã€‚`Flow` æ¥å—ç”Ÿæˆå™¨å‡½æ•°ä½œä¸ºå®ƒçš„å”¯ä¸€è¾“å…¥ã€‚å®ƒç›¸å½“äºæ˜¯ä¸€ä¸ª `generator` çš„è‡ªåŠ¨æ‰§è¡Œå™¨(ç±»ä¼¼`co`)ã€‚

åœ¨ç”Ÿæˆå™¨å†…éƒ¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ `yield` å®ƒä»¬æ¥ä¸²è” `promise`(ç”¨ `yield somePromise`ä»£æ›¿ `await somePromise`)ã€‚ç„¶åï¼Œæµæœºåˆ¶èƒ½åœ¨ `promise` è§£å†³(`resolved`)ä¹‹åï¼Œ`generator` ç»§ç»­æ‰§è¡Œæˆ–è€…æŠ›å‡ºé”™è¯¯ã€‚

å› æ­¤ï¼Œ`flow`æ˜¯ `async / await` çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä¸éœ€è¦ä»»ä½•è¿›ä¸€æ­¥çš„æ“ä½œåŒ…è£…ã€‚å®ƒçš„åº”ç”¨æ–¹å¼å¦‚ä¸‹:

+ ä½¿ç”¨ `flow` åŒ…è£¹å¼‚æ­¥å‡½æ•°ã€‚
+ ä½¿ç”¨ `function *` ä»£æ›¿ `async`ã€‚
+ ä½¿ç”¨ `yield` ä»£æ›¿ `await`ã€‚

æ¥çœ‹ä¸€ä¸ªä½¿ç”¨ `flow`ä»£æ›¿å¼‚æ­¥`action`çš„æ–¹æ¡ˆï¼Œæ³¨æ„ä½¿ç”¨ `flow` åŒ…è£¹ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…è£…åœ¨ `promise` ä¸­çš„ç”Ÿæˆå™¨è‡ªåŠ¨æ‰§è¡Œå™¨ï¼Œæ‰€ä»¥ç±»å¤–æ‰§è¡Œè¿™ä¸ªç”Ÿæˆå™¨å‡½æ•°éœ€è¦è°ƒç”¨ä¸€ä¸‹ `await`ï¼š

```ts
import { flow, makeAutoObservable, flowResult } from "mobx"

class Store {
    githubProjects = []
    state = "pending"

    constructor() {
        makeAutoObservable(this, {
            fetchProjects: flow
        })
    }

    // Note the star, this a generator function!
    *fetchProjects() {
        this.githubProjects = []
        this.state = "pending"
        try {
            // Yield instead of await.
            const projects = yield fetchGithubProjectsSomehow()
            const filteredProjects = somePreprocessing(projects)
            this.state = "done"
            this.githubProjects = filteredProjects
        } catch (error) {
            this.state = "error"
        }
    }
}

const store = new Store()
const projects = await store.fetchProjects()
```

### `flowResult(flowedFn)`

å¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨ `typescript`ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ `flow` æ³¨è§£çš„ç”Ÿæˆå™¨å‡½æ•°çš„æ—¶å€™éœ€è¦åŒ…è£¹ä¸€ä¸ª `flowResult` å‡½æ•°ã€‚

```ts
const projects = await flowResult(store.fetchProjects())
```

è¿™æ˜¯å› ä¸ºå‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä½¿ç”¨ `flow` æ³¨è§£ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåŒ…è£…åœ¨ `promise` ä¸­çš„ç”Ÿæˆå™¨è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚

ç„¶è€Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡è£…é¥°å™¨å®ç°çš„ï¼Œ`TypeScript`å¹¶æ— æ³•è¯†åˆ«è¿™ç§è½¬æ¢ï¼Œåœ¨ `typescript` çœ¼é‡Œè¿™ä¸ª `fetchProjects` å‡½æ•°è¿˜æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ç±»å‹è€Œä¸æ˜¯è£…é¥°ä¹‹åè¿”å›çš„ `promise`ã€‚

æ‰€ä»¥ `flowResult` ä¼šç¡®ä¿ `TypeScript` æ£€æµ‹åˆ°è¿™ç§ç±»å‹çš„å˜åŒ–ï¼Œç›¸å½“äºæ˜¯ä¸€å±‚ç±»å‹æ¨æ–­ã€‚

### `flow.bound`

`flow.bound`æ³¨é‡Šå¯ç”¨äºè‡ªåŠ¨å°†æ–¹æ³•ç»‘å®šåˆ°æ­£ç¡®çš„å®ä¾‹ã€‚

## `flow(fn)`

`flow`å’Œ `action` ä¸€æ ·ï¼Œå¯ä»¥ç›´æ¥ç”¨äºåŒ…è£…å‡½æ•°ã€‚ä¸Šé¢çš„ä¾‹å­ä¹Ÿå¯ä»¥å†™æˆè¿™æ ·ï¼š

```ts
import { flow } from "mobx"

class Store {
    githubProjects = []
    state = "pending"

    fetchProjects = flow(function* (this: Store) {
        this.githubProjects = []
        this.state = "pending"
        try {
            // yield instead of await.
            const projects = yield fetchGithubProjectsSomehow()
            const filteredProjects = somePreprocessing(projects)
            this.state = "done"
            this.githubProjects = filteredProjects
        } catch (error) {
            this.state = "error"
        }
    })
}

const store = new Store()
const projects = await store.fetchProjects()
```

ä½¿ç”¨ `flow(fn)` è¿™ç§å½¢å¼çš„å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦åœ¨ `typescript` ä¸­ä½¿ç”¨ `flowResult` åŒ…è£¹ `store.fetchProjects`ã€‚

## Cancelling flows {ğŸš€}

`flow` çš„å¦ä¸€ä¸ªä¼˜åŠ¿æ˜¯å®ƒä»¬æ˜¯å¯ä»¥å–æ¶ˆçš„ã€‚`flow` çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª `promise`ï¼Œè¿™ä¸ª ``promise` çš„ `resolved` çŠ¶æ€çš„ç»“æœå€¼æ˜¯æœ€åä»ç”Ÿæˆå™¨å‡½æ•°è¿”å›çš„å€¼ã€‚

è¿”å›çš„ `promise` æœ‰ä¸€ä¸ªé¢å¤–çš„ `cancel()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ä¸­æ–­è¿è¡Œçš„ç”Ÿæˆå™¨(`generator`)å¹¶å–æ¶ˆå®ƒã€‚ä¸è¿‡ä»»ä½• `try / finally`å­å¥ä»ç„¶ä¼šè¿è¡Œã€‚

