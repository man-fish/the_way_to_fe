# Goæ“ä½œMySQLğŸ“‹

## è¿æ¥

Goè¯­è¨€ä¸­çš„`database/sql`åŒ…æä¾›äº†ä¿è¯SQLæˆ–ç±»SQLæ•°æ®åº“çš„æ³›ç”¨æ¥å£ï¼Œå¹¶ä¸æä¾›å…·ä½“çš„æ•°æ®åº“é©±åŠ¨ã€‚ä½¿ç”¨`database/sql`åŒ…æ—¶å¿…é¡»æ³¨å…¥ï¼ˆè‡³å°‘ï¼‰ä¸€ä¸ªæ•°æ®åº“é©±åŠ¨ã€‚

æˆ‘ä»¬å¸¸ç”¨çš„æ•°æ®åº“åŸºæœ¬ä¸Šéƒ½æœ‰å®Œæ•´çš„ç¬¬ä¸‰æ–¹å®ç°ã€‚ä¾‹å¦‚ï¼š[MySQLé©±åŠ¨](https://github.com/go-sql-driver/mysql)

### ä¸‹è½½é©±åŠ¨

```bash
go get -u github.com/go-sql-driver/mysql
```

### ä½¿ç”¨MySQLé©±åŠ¨

```go
func Open(driverName, dataSourceName string) (*DB, error)
```

Openæ‰“å¼€ä¸€ä¸ªdirverNameæŒ‡å®šçš„æ•°æ®åº“ï¼ŒdataSourceNameæŒ‡å®šæ•°æ®æºï¼Œä¸€èˆ¬åŒ…è‡³å°‘æ‹¬æ•°æ®åº“æ–‡ä»¶åå’Œï¼ˆå¯èƒ½çš„ï¼‰è¿æ¥ä¿¡æ¯ã€‚

```go
import (
	"database/sql"

	_ "github.com/go-sql-driver/mysql"
)

func main() {
   // DSN:Data Source Name
	dsn := "user:password@tcp(127.0.0.1:3306)/dbname"
	db, err := sql.Open("mysql", dsn)
	if err != nil {
		panic(err)
	}
	defer db.Close()
}
```

### åˆå§‹åŒ–è¿æ¥

Openå‡½æ•°å¯èƒ½åªæ˜¯éªŒè¯å…¶å‚æ•°ï¼Œè€Œä¸åˆ›å»ºä¸æ•°æ®åº“çš„è¿æ¥ã€‚å¦‚æœè¦æ£€æŸ¥æ•°æ®æºçš„åç§°æ˜¯å¦åˆæ³•ï¼Œåº”è°ƒç”¨è¿”å›å€¼çš„Pingæ–¹æ³•ã€‚

è¿”å›çš„DBå¯ä»¥å®‰å…¨çš„è¢«å¤šä¸ªgoroutineåŒæ—¶ä½¿ç”¨ï¼Œå¹¶ä¼šç»´æŠ¤è‡ªèº«çš„é—²ç½®è¿æ¥æ± ã€‚è¿™æ ·ä¸€æ¥ï¼ŒOpenå‡½æ•°åªéœ€è°ƒç”¨ä¸€æ¬¡ã€‚å¾ˆå°‘éœ€è¦å…³é—­DBã€‚

```go
// å®šä¹‰ä¸€ä¸ªå…¨å±€å¯¹è±¡db
var db *sql.DB

// å®šä¹‰ä¸€ä¸ªåˆå§‹åŒ–æ•°æ®åº“çš„å‡½æ•°
func initDB() (err error) {
	// DSN:Data Source Name
	dsn := "user:password@tcp(127.0.0.1:3306)/test"
	// ä¸ä¼šæ ¡éªŒè´¦å·å¯†ç æ˜¯å¦æ­£ç¡®
	// æ³¨æ„ï¼ï¼ï¼è¿™é‡Œä¸è¦ä½¿ç”¨:=ï¼Œæˆ‘ä»¬æ˜¯ç»™å…¨å±€å˜é‡èµ‹å€¼ï¼Œç„¶ååœ¨mainå‡½æ•°ä¸­ä½¿ç”¨å…¨å±€å˜é‡db
	db, err = sql.Open("mysql", dsn)
	if err != nil {
		return err
	}
	// å°è¯•ä¸æ•°æ®åº“å»ºç«‹è¿æ¥ï¼ˆæ ¡éªŒdsnæ˜¯å¦æ­£ç¡®ï¼‰
	err = db.Ping()
	if err != nil {
		return err
	}
	return nil
    //æ£€æµ‹é€šä¿¡æ˜¯å¦æˆåŠŸ
}

func main() {
	err := initDB() // è°ƒç”¨è¾“å‡ºåŒ–æ•°æ®åº“çš„å‡½æ•°
	if err != nil {
		fmt.Printf("init db failed,err:%v\n", err)
		return
	}
}
```

[å…¶ä¸­`sql.DB`æ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼ˆæ“ä½œï¼‰å¥æŸ„ï¼Œä»£è¡¨ä¸€ä¸ªå…·æœ‰é›¶åˆ°å¤šä¸ªåº•å±‚è¿æ¥çš„è¿æ¥æ± ã€‚å®ƒå¯ä»¥å®‰å…¨çš„è¢«å¤šä¸ªgoç¨‹åŒæ—¶ä½¿ç”¨ã€‚`database/sql`åŒ…ä¼šè‡ªåŠ¨åˆ›å»ºå’Œé‡Šæ”¾è¿æ¥ï¼›å®ƒä¹Ÿä¼šç»´æŠ¤ä¸€ä¸ªé—²ç½®è¿æ¥çš„è¿æ¥æ± ã€‚]()

### SetMaxOpenConns

```go
func (db *DB) SetMaxOpenConns(n int)
```

`SetMaxOpenConns`è®¾ç½®ä¸æ•°æ®åº“å»ºç«‹è¿æ¥çš„æœ€å¤§æ•°ç›®ã€‚ å¦‚æœnå¤§äº0ä¸”å°äºæœ€å¤§é—²ç½®è¿æ¥æ•°ï¼Œä¼šå°†æœ€å¤§é—²ç½®è¿æ¥æ•°å‡å°åˆ°åŒ¹é…æœ€å¤§å¼€å¯è¿æ¥æ•°çš„é™åˆ¶ã€‚ å¦‚æœn<=0ï¼Œä¸ä¼šé™åˆ¶æœ€å¤§å¼€å¯è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º0ï¼ˆæ— é™åˆ¶ï¼‰ã€‚

### SetMaxIdleConns

```go
func (db *DB) SetMaxIdleConns(n int)
```

SetMaxIdleConnsè®¾ç½®è¿æ¥æ± ä¸­çš„æœ€å¤§é—²ç½®è¿æ¥æ•°ã€‚ å¦‚æœnå¤§äºæœ€å¤§å¼€å¯è¿æ¥æ•°ï¼Œåˆ™æ–°çš„æœ€å¤§é—²ç½®è¿æ¥æ•°ä¼šå‡å°åˆ°åŒ¹é…æœ€å¤§å¼€å¯è¿æ¥æ•°çš„é™åˆ¶ã€‚ å¦‚æœn<=0ï¼Œä¸ä¼šä¿ç•™é—²ç½®è¿æ¥ã€‚

## CRUD

### å»ºåº“å»ºè¡¨

æˆ‘ä»¬å…ˆåœ¨MySQLä¸­åˆ›å»ºä¸€ä¸ªåä¸º`sql_test`çš„æ•°æ®åº“

```sql
CREATE DATABASE sql_test;
```

è¿›å…¥è¯¥æ•°æ®åº“:

```sql
use sql_test;
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€å¼ ç”¨äºæµ‹è¯•çš„æ•°æ®è¡¨ï¼š

```sql
CREATE TABLE `user` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(20) DEFAULT '',
    `age` INT(11) DEFAULT '0',
    PRIMARY KEY(`id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
```

### æŸ¥è¯¢

#### å•è¡ŒæŸ¥è¯¢

å•è¡ŒæŸ¥è¯¢`db.QueryRow()`æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œå¹¶æœŸæœ›è¿”å›æœ€å¤šä¸€è¡Œç»“æœï¼ˆå³Rowï¼‰ã€‚QueryRowæ€»æ˜¯è¿”å›énilçš„å€¼ï¼Œç›´åˆ°è¿”å›å€¼çš„Scanæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæ‰ä¼šè¿”å›è¢«å»¶è¿Ÿçš„é”™è¯¯ã€‚ï¼ˆå¦‚ï¼šæœªæ‰¾åˆ°ç»“æœï¼‰ï¼Œè¦è¯»å–ç»“æœéœ€è¦å…ˆåˆ›å»ºå’Œè¿”å›å†…å®¹åŒæ ·å­—æ®µçš„ç»“æ„ä½“ã€‚

```go
func (db *DB) QueryRow(query string, args ...interface{}) *Row
```

å…·ä½“ç¤ºä¾‹ä»£ç ï¼š

```go
type user struct{
	id int
	name string
	age int
}
// æŸ¥è¯¢å•æ¡æ•°æ®ç¤ºä¾‹
func queryRowDemo() {
	sqlStr := "select id, name, age from user where id=?"
	var u user
	// éå¸¸é‡è¦ï¼šç¡®ä¿QueryRowä¹‹åè°ƒç”¨Scanæ–¹æ³•ï¼Œå¦åˆ™æŒæœ‰çš„æ•°æ®åº“é“¾æ¥ä¸ä¼šè¢«é‡Šæ”¾
	err := db.QueryRow(sqlStr, 1).Scan(&u.id, &u.name, &u.age)
	if err != nil {
		fmt.Printf("scan failed, err:%v\n", err)
		return
	}
	fmt.Printf("id:%d name:%s age:%d\n", u.id, u.name, u.age)
}
```

#### å¤šè¡ŒæŸ¥è¯¢

å¤šè¡ŒæŸ¥è¯¢`db.Query()`æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œè¿”å›å¤šè¡Œç»“æœï¼ˆå³Rowsï¼‰ï¼Œä¸€èˆ¬ç”¨äºæ‰§è¡Œselectå‘½ä»¤ã€‚å‚æ•°argsè¡¨ç¤ºqueryä¸­çš„å ä½å‚æ•°ã€‚

```go
func (db *DB) Query(query string, args ...interface{}) (*Rows, error)
```

```go
func (rs *Rows) Next() bool
```

å…·ä½“ç¤ºä¾‹ä»£ç ï¼š

```go
// æŸ¥è¯¢å¤šæ¡æ•°æ®ç¤ºä¾‹
func queryMultiRowDemo() {
	sqlStr := "select id, name, age from user where id > ?"
	rows, err := db.Query(sqlStr, 0)
	if err != nil {
		fmt.Printf("query failed, err:%v\n", err)
		return
	}
	// éå¸¸é‡è¦ï¼šå…³é—­rowsé‡Šæ”¾æŒæœ‰çš„æ•°æ®åº“é“¾æ¥
	defer rows.Close()

	// å¾ªç¯è¯»å–ç»“æœé›†ä¸­çš„æ•°æ®
	for rows.Next() {
		var u user
		err := rows.Scan(&u.id, &u.name, &u.age)
		if err != nil {
			fmt.Printf("scan failed, err:%v\n", err)
			return
		}
		fmt.Printf("id:%d name:%s age:%d\n", u.id, u.name, u.age)
	}
}
```

### æ’å…¥æ•°æ®

æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œéƒ½ä½¿ç”¨æ–¹æ³•ã€‚

```go
func (db *DB) Exec(query string, args ...interface{}) (Result, error)
```

Execæ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼ˆåŒ…æ‹¬æŸ¥è¯¢ã€åˆ é™¤ã€æ›´æ–°ã€æ’å…¥ç­‰ï¼‰ï¼Œè¿”å›çš„Resultæ˜¯å¯¹å·²æ‰§è¡Œçš„SQLå‘½ä»¤çš„æ€»ç»“ã€‚å‚æ•°argsè¡¨ç¤ºqueryä¸­çš„å ä½å‚æ•°ã€‚

å…·ä½“æ’å…¥æ•°æ®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
// æ’å…¥æ•°æ®
func insertRowDemo() {
	sqlStr := "insert into user(name, age) values (?,?)"
	ret, err := db.Exec(sqlStr, "ç‹äº”", 38)
	if err != nil {
		fmt.Printf("insert failed, err:%v\n", err)
		return
	}
	theID, err := ret.LastInsertId() // æ–°æ’å…¥æ•°æ®çš„id
	if err != nil {
		fmt.Printf("get lastinsert ID failed, err:%v\n", err)
		return
	}
	fmt.Printf("insert success, the id is %d.\n", theID)
}
```

### æ›´æ–°æ•°æ®

å…·ä½“æ›´æ–°æ•°æ®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
// æ›´æ–°æ•°æ®
func updateRowDemo() {
	sqlStr := "update user set age=? where id = ?"
	ret, err := db.Exec(sqlStr, 39, 3)
	if err != nil {
		fmt.Printf("update failed, err:%v\n", err)
		return
	}
	n, err := ret.RowsAffected() // æ“ä½œå½±å“çš„è¡Œæ•°
	if err != nil {
		fmt.Printf("get RowsAffected failed, err:%v\n", err)
		return
	}
	fmt.Printf("update success, affected rows:%d\n", n)
}
```

### åˆ é™¤æ•°æ®

å…·ä½“åˆ é™¤æ•°æ®çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
// åˆ é™¤æ•°æ®
func deleteRowDemo() {
	sqlStr := "delete from user where id = ?"
	ret, err := db.Exec(sqlStr, 3)
	if err != nil {
		fmt.Printf("delete failed, err:%v\n", err)
		return
	}
	n, err := ret.RowsAffected() // æ“ä½œå½±å“çš„è¡Œæ•°
	if err != nil {
		fmt.Printf("get RowsAffected failed, err:%v\n", err)
		return
	}
	fmt.Printf("delete success, affected rows:%d\n", n)
}
```

## MySQLé¢„å¤„ç†

### ä»€ä¹ˆæ˜¯é¢„å¤„ç†ï¼Ÿ

æ™®é€šSQLè¯­å¥æ‰§è¡Œè¿‡ç¨‹ï¼š

1. å®¢æˆ·ç«¯å¯¹SQLè¯­å¥è¿›è¡Œå ä½ç¬¦æ›¿æ¢å¾—åˆ°å®Œæ•´çš„SQLè¯­å¥ã€‚
2. å®¢æˆ·ç«¯å‘é€å®Œæ•´SQLè¯­å¥åˆ°MySQLæœåŠ¡ç«¯
3. MySQLæœåŠ¡ç«¯æ‰§è¡Œå®Œæ•´çš„SQLè¯­å¥å¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

é¢„å¤„ç†æ‰§è¡Œè¿‡ç¨‹ï¼š

1. æŠŠSQLè¯­å¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå‘½ä»¤éƒ¨åˆ†ä¸æ•°æ®éƒ¨åˆ†ã€‚
2. å…ˆæŠŠå‘½ä»¤éƒ¨åˆ†å‘é€ç»™MySQLæœåŠ¡ç«¯ï¼ŒMySQLæœåŠ¡ç«¯è¿›è¡ŒSQLé¢„å¤„ç†ã€‚
3. ç„¶åæŠŠæ•°æ®éƒ¨åˆ†å‘é€ç»™MySQLæœåŠ¡ç«¯ï¼ŒMySQLæœåŠ¡ç«¯å¯¹SQLè¯­å¥è¿›è¡Œå ä½ç¬¦æ›¿æ¢ã€‚
4. MySQLæœåŠ¡ç«¯æ‰§è¡Œå®Œæ•´çš„SQLè¯­å¥å¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

### ä¸ºä»€ä¹ˆè¦é¢„å¤„ç†ï¼Ÿ

1. ä¼˜åŒ–MySQLæœåŠ¡å™¨é‡å¤æ‰§è¡ŒSQLçš„æ–¹æ³•ï¼Œå¯ä»¥æå‡æœåŠ¡å™¨æ€§èƒ½ï¼Œæå‰è®©æœåŠ¡å™¨ç¼–è¯‘ï¼Œä¸€æ¬¡ç¼–è¯‘å¤šæ¬¡æ‰§è¡Œï¼ŒèŠ‚çœåç»­ç¼–è¯‘çš„æˆæœ¬ã€‚
2. é¿å…SQLæ³¨å…¥é—®é¢˜ï¼Œé¿å…æˆ‘ä»¬è‡ªå·±æ‹¼æ¥sqlè¯­å¥ï¼Œä¼ è¿‡å»ç»™Mysqlçš„å‚æ•°æ•°æ®åº“å¼•æ“ä¼šè¿›è¡Œæ£€éªŒã€‚

### Goå®ç°MySQLé¢„å¤„ç†

Goä¸­çš„

```go
func (db *DB) Prepare(query string) (*Stmt, error)
```

`Prepare`æ–¹æ³•ä¼šå…ˆå°†sqlè¯­å¥å‘é€ç»™MySQLæœåŠ¡ç«¯ï¼Œè¿”å›ä¸€ä¸ªå‡†å¤‡å¥½çš„çŠ¶æ€ç”¨äºä¹‹åçš„æŸ¥è¯¢å’Œå‘½ä»¤ã€‚è¿”å›å€¼å¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªæŸ¥è¯¢å’Œå‘½ä»¤ã€‚

æŸ¥è¯¢æ“ä½œçš„é¢„å¤„ç†ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
// é¢„å¤„ç†æŸ¥è¯¢ç¤ºä¾‹
func prepareQueryDemo() {
	sqlStr := "select id, name, age from user where id > ?"
	stmt, err := db.Prepare(sqlStr)
	if err != nil {
		fmt.Printf("prepare failed, err:%v\n", err)
		return
	}
	defer stmt.Close()
	rows, err := stmt.Query(0)
	if err != nil {
		fmt.Printf("query failed, err:%v\n", err)
		return
	}
	defer rows.Close()
	// å¾ªç¯è¯»å–ç»“æœé›†ä¸­çš„æ•°æ®
	for rows.Next() {
		var u user
		err := rows.Scan(&u.id, &u.name, &u.age)
		if err != nil {
			fmt.Printf("scan failed, err:%v\n", err)
			return
		}
		fmt.Printf("id:%d name:%s age:%d\n", u.id, u.name, u.age)
	}
}
```

æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œçš„é¢„å¤„ç†ååˆ†ç±»ä¼¼ï¼Œè¿™é‡Œä»¥æ’å…¥æ“ä½œçš„é¢„å¤„ç†ä¸ºä¾‹ï¼š

```go
// é¢„å¤„ç†æ’å…¥ç¤ºä¾‹
func prepareInsertDemo() {
	sqlStr := "insert into user(name, age) values (?,?)"
	stmt, err := db.Prepare(sqlStr)
	if err != nil {
		fmt.Printf("prepare failed, err:%v\n", err)
		return
	}
	defer stmt.Close()
	_, err = stmt.Exec("å°ç‹å­", 18)
	if err != nil {
		fmt.Printf("insert failed, err:%v\n", err)
		return
	}
	_, err = stmt.Exec("æ²™æ²³å¨œæ‰", 18)
	if err != nil {
		fmt.Printf("insert failed, err:%v\n", err)
		return
	}
	fmt.Println("insert success.")
}
```

## Goå®ç°MySQLäº‹åŠ¡

### ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ

äº‹åŠ¡ï¼šä¸€ä¸ªæœ€å°çš„ä¸å¯å†åˆ†çš„å·¥ä½œå•å…ƒï¼›é€šå¸¸ä¸€ä¸ªäº‹åŠ¡å¯¹åº”ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡(ä¾‹å¦‚é“¶è¡Œè´¦æˆ·è½¬è´¦ä¸šåŠ¡ï¼Œè¯¥ä¸šåŠ¡å°±æ˜¯ä¸€ä¸ªæœ€å°çš„å·¥ä½œå•å…ƒ)ï¼ŒåŒæ—¶è¿™ä¸ªå®Œæ•´çš„ä¸šåŠ¡éœ€è¦æ‰§è¡Œå¤šæ¬¡çš„DML(insertã€updateã€delete)è¯­å¥å…±åŒè”åˆå®Œæˆã€‚Aè½¬è´¦ç»™Bï¼Œè¿™é‡Œé¢å°±éœ€è¦æ‰§è¡Œä¸¤æ¬¡updateæ“ä½œã€‚

åœ¨MySQLä¸­åªæœ‰ä½¿ç”¨äº†`Innodb`æ•°æ®åº“å¼•æ“çš„æ•°æ®åº“æˆ–è¡¨æ‰æ”¯æŒäº‹åŠ¡ã€‚äº‹åŠ¡å¤„ç†å¯ä»¥ç”¨æ¥ç»´æŠ¤æ•°æ®åº“çš„å®Œæ•´æ€§ï¼Œä¿è¯æˆæ‰¹çš„SQLè¯­å¥è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚

### äº‹åŠ¡çš„ACID

é€šå¸¸äº‹åŠ¡å¿…é¡»æ»¡è¶³4ä¸ªæ¡ä»¶ï¼ˆACIDï¼‰ï¼šåŸå­æ€§ï¼ˆAtomicityï¼Œæˆ–ç§°ä¸å¯åˆ†å‰²æ€§ï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼Œåˆç§°ç‹¬ç«‹æ€§ï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚

|  æ¡ä»¶  |                             è§£é‡Š                             |
| :----: | :----------------------------------------------------------: |
| åŸå­æ€§ | ä¸€ä¸ªäº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸ä¼šç»“æŸåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›æ»šï¼ˆRollbackï¼‰åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚ |
| ä¸€è‡´æ€§ | åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚è¿™è¡¨ç¤ºå†™å…¥çš„èµ„æ–™å¿…é¡»å®Œå…¨ç¬¦åˆæ‰€æœ‰çš„é¢„è®¾è§„åˆ™ï¼Œè¿™åŒ…å«èµ„æ–™çš„ç²¾ç¡®åº¦ã€ä¸²è”æ€§ä»¥åŠåç»­æ•°æ®åº“å¯ä»¥è‡ªå‘æ€§åœ°å®Œæˆé¢„å®šçš„å·¥ä½œã€‚ |
| éš”ç¦»æ€§ | æ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹å…¶æ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œéš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚äº‹åŠ¡éš”ç¦»åˆ†ä¸ºä¸åŒçº§åˆ«ï¼ŒåŒ…æ‹¬è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚ |
| æŒä¹…æ€§ | äº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…çš„ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ |

### äº‹åŠ¡ç›¸å…³æ–¹æ³•

Goè¯­è¨€ä¸­ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•å®ç°MySQLä¸­çš„äº‹åŠ¡æ“ä½œã€‚ å¼€å§‹äº‹åŠ¡

```go
func (db *DB) Begin() (*Tx, error)
```

æäº¤äº‹åŠ¡

```go
func (tx *Tx) Commit() error
```

å›æ»šäº‹åŠ¡

```go
func (tx *Tx) Rollback() error
```

### äº‹åŠ¡ç¤ºä¾‹

ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†ä¸€ä¸ªç®€å•çš„äº‹åŠ¡æ“ä½œï¼Œè¯¥äº‹ç‰©æ“ä½œèƒ½å¤Ÿç¡®ä¿ä¸¤æ¬¡æ›´æ–°æ“ä½œè¦ä¹ˆåŒæ—¶æˆåŠŸè¦ä¹ˆåŒæ—¶å¤±è´¥ï¼Œä¸ä¼šå­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚

```go
// äº‹åŠ¡æ“ä½œç¤ºä¾‹
func transactionDemo() {
	tx, err := db.Begin() // å¼€å¯äº‹åŠ¡
	if err != nil {
		if tx != nil {
			tx.Rollback() // å›æ»š
		}
		fmt.Printf("begin trans failed, err:%v\n", err)
		return
	}
	sqlStr1 := "Update user set age=30 where id=?"
	_, err = tx.Exec(sqlStr1, 2)
	if err != nil {
		tx.Rollback() // å›æ»š
		fmt.Printf("exec sql1 failed, err:%v\n", err)
		return
	}
	sqlStr2 := "Update user set age=40 where id=?"
	_, err = tx.Exec(sqlStr2, 4)
	if err != nil {
		tx.Rollback() // å›æ»š
		fmt.Printf("exec sql2 failed, err:%v\n", err)
		return
	}
	err = tx.Commit() // æäº¤äº‹åŠ¡
	if err != nil {
		tx.Rollback() // å›æ»š
		fmt.Printf("commit failed, err:%v\n", err)
		return
	}
	fmt.Println("exec trans success!")
}
```

### æ•°æ®åº“äº‹åŠ¡å’Œé¢„å¤„ç†ç»“åˆ

`Begin`æ–¹æ³•è¿”å›çš„`tx`ç»“æ„ä½“ä¹Ÿæœ‰`Prepare`æ–¹æ³•ï¼Œå…¶è¿”å›çš„`stat`ä¹Ÿå¯ä»¥è¢«å›æ»šã€‚

```go
func transcationDemo() {
	tx, err := db.Begin()
	if err != nil {
		if tx != nil {
			tx.Rollback()
		}
		fmt.Printf("begin trans failed, err:%v\n", err)
		return
	}
	sqlStr := "update user set age = 11111 where id = ?"
	stat, err := tx.Prepare(sqlStr)
	if err != nil {
		tx.Rollback()
		fmt.Printf("Prepare failed, err:%v\n", err)
		return
	}
	_,err = stat.Exec(6)
	if err != nil {
		tx.Rollback()
		fmt.Printf("Prepare Exec failed, err:%v\n", err)
		return
	}
	sqlStr = "update user set w = 7777 where id = ?"
	_, err = tx.Exec(sqlStr,100)
	if err != nil {
		tx.Rollback()
		fmt.Printf("tx Exec failed, err:%v\n", err)
		return
	}
	err = tx.Commit()
	if err != nil {
		tx.Rollback()
		fmt.Printf("commit failed, err:%v\n", err)
		return
	}
	fmt.Println("Exec trans success")
}

```



# sqlxä½¿ç”¨

ç¬¬ä¸‰æ–¹åº“`sqlx`èƒ½å¤Ÿç®€åŒ–æ“ä½œï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚

## å®‰è£…

```go
go get github.com/jmoiron/sqlx
```

## åŸºæœ¬ä½¿ç”¨

### è¿æ¥æ•°æ®åº“

```go
var db *sqlx.DB

func initDB() (err error) {
	dsn := "user:password@tcp(127.0.0.1:3306)/test"
	// ä¹Ÿå¯ä»¥ä½¿ç”¨MustConnectè¿æ¥ä¸æˆåŠŸå°±panic
	db, err = sqlx.Connect("mysql", dsn)
	if err != nil {
		fmt.Printf("connect DB failed, err:%v\n", err)
		return
	}
	db.SetMaxOpenConns(20)
	db.SetMaxIdleConns(10)
	return
}
```

### æŸ¥è¯¢

æŸ¥è¯¢å•è¡Œæ•°æ®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
// æŸ¥è¯¢å•æ¡æ•°æ®ç¤ºä¾‹
func queryRowDemo() {
	sqlStr := "select id, name, age from user where id=?"
	var u user
	err := db.Get(&u, sqlStr, 1)
	if err != nil {
		fmt.Printf("get failed, err:%v\n", err)
		return
	}
	fmt.Printf("id:%d name:%s age:%d\n", u.ID, u.Name, u.Age)
}
```

æŸ¥è¯¢å¤šè¡Œæ•°æ®ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
// æŸ¥è¯¢å¤šæ¡æ•°æ®ç¤ºä¾‹
func queryMultiRowDemo() {
	sqlStr := "select id, name, age from user where id > ?"
	var users []user
	err := db.Select(&users, sqlStr, 0)
	if err != nil {
		fmt.Printf("query failed, err:%v\n", err)
		return
	}
	fmt.Printf("users:%#v\n", users)
}
```

### æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤

sqlxä¸­çš„execæ–¹æ³•ä¸åŸç”Ÿsqlä¸­çš„execä½¿ç”¨åŸºæœ¬ä¸€è‡´ï¼š

```go
// æ’å…¥æ•°æ®
func insertRowDemo() {
	sqlStr := "insert into user(name, age) values (?,?)"
	ret, err := db.Exec(sqlStr, "æ²™æ²³å°ç‹å­", 19)
	if err != nil {
		fmt.Printf("insert failed, err:%v\n", err)
		return
	}
	theID, err := ret.LastInsertId() // æ–°æ’å…¥æ•°æ®çš„id
	if err != nil {
		fmt.Printf("get lastinsert ID failed, err:%v\n", err)
		return
	}
	fmt.Printf("insert success, the id is %d.\n", theID)
}

// æ›´æ–°æ•°æ®
func updateRowDemo() {
	sqlStr := "update user set age=? where id = ?"
	ret, err := db.Exec(sqlStr, 39, 6)
	if err != nil {
		fmt.Printf("update failed, err:%v\n", err)
		return
	}
	n, err := ret.RowsAffected() // æ“ä½œå½±å“çš„è¡Œæ•°
	if err != nil {
		fmt.Printf("get RowsAffected failed, err:%v\n", err)
		return
	}
	fmt.Printf("update success, affected rows:%d\n", n)
}

// åˆ é™¤æ•°æ®
func deleteRowDemo() {
	sqlStr := "delete from user where id = ?"
	ret, err := db.Exec(sqlStr, 6)
	if err != nil {
		fmt.Printf("delete failed, err:%v\n", err)
		return
	}
	n, err := ret.RowsAffected() // æ“ä½œå½±å“çš„è¡Œæ•°
	if err != nil {
		fmt.Printf("get RowsAffected failed, err:%v\n", err)
		return
	}
	fmt.Printf("delete success, affected rows:%d\n", n)
}
```

### äº‹åŠ¡æ“ä½œ

å¯¹äºäº‹åŠ¡æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`sqlx`ä¸­æä¾›çš„`db.Beginx()`å’Œ`tx.MustExec()`æ–¹æ³•æ¥ç®€åŒ–é”™è¯¯å¤„ç†è¿‡ç¨‹ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
func transactionDemo() {
	tx, err := db.Beginx() // å¼€å¯äº‹åŠ¡
	if err != nil {
		if tx != nil {
			tx.Rollback()
		}
		fmt.Printf("begin trans failed, err:%v\n", err)
		return
	}
	sqlStr1 := "Update user set age=40 where id=?"
	tx.MustExec(sqlStr1, 2)
	sqlStr2 := "Update user set age=50 where id=?"
	tx.MustExec(sqlStr2, 4)
	err = tx.Commit() // æäº¤äº‹åŠ¡
	if err != nil {
		tx.Rollback() // å›æ»š
		fmt.Printf("commit failed, err:%v\n", err)
		return
	}
	fmt.Println("exec trans success!")
}
```

# æ³¨æ„äº‹é¡¹

## SQLä¸­çš„å ä½ç¬¦

ä¸åŒçš„æ•°æ®åº“ä¸­ï¼ŒSQLè¯­å¥ä½¿ç”¨çš„å ä½ç¬¦è¯­æ³•ä¸å°½ç›¸åŒã€‚

|   æ•°æ®åº“   |  å ä½ç¬¦è¯­æ³•  |
| :--------: | :----------: |
|   MySQL    |     `?`      |
| PostgreSQL | `$1`, `$2`ç­‰ |
|   SQLite   |  `?` å’Œ`$1`  |
|   Oracle   |   `:name`    |

## SQLæ³¨å…¥

**æˆ‘ä»¬ä»»ä½•æ—¶å€™éƒ½ä¸åº”è¯¥è‡ªå·±æ‹¼æ¥SQLè¯­å¥ï¼**

è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºä¸€ä¸ªè‡ªè¡Œæ‹¼æ¥SQLè¯­å¥çš„ç¤ºä¾‹ï¼Œç¼–å†™ä¸€ä¸ªæ ¹æ®nameå­—æ®µæŸ¥è¯¢userè¡¨çš„å‡½æ•°å¦‚ä¸‹ï¼š

```go
// sqlæ³¨å…¥ç¤ºä¾‹
func sqlInjectDemo(name string) {
	sqlStr := fmt.Sprintf("select id, name, age from user where name='%s'", name)
	fmt.Printf("SQL:%s\n", sqlStr)

	var users []user
	err := db.Select(&users, sqlStr)
	if err != nil {
		fmt.Printf("exec failed, err:%v\n", err)
		return
	}
	for _, u := range users {
		fmt.Printf("user:%#v\n", u)
	}
}
```

æ­¤æ—¶ä»¥ä¸‹è¾“å…¥å­—ç¬¦ä¸²éƒ½å¯ä»¥å¼•å‘SQLæ³¨å…¥é—®é¢˜ï¼š

```go
sqlInjectDemo("xxx' or 1=1#")
sqlInjectDemo("xxx' union select * from user #")
sqlInjectDemo("xxx' and (select count(*) from user) <10 #")
```

[å¦‚ä½•è§£å†³Sqlæ³¨å…¥ï¼š]()

ä¸è¦è‡ªå·±æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œä½¿ç”¨é¢„å¤„ç†çš„æ–¹å¼ï¼Œæ•°æ®åº“çš„å¼•æ“ä¼šå¸®ä½ åšå‚æ•°æ ¡éªŒï¼Œä¸ç„¶å°±éœ€è¦è‡ªå·±å»å†™å‚æ•°æ ¡éªŒã€‚ 