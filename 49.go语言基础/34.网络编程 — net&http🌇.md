# ç½‘ç»œç¼–ç¨‹ â€” net&httpğŸŒ

## å‘é€GETè¯·æ±‚ğŸ“¡

### http.Getâ›µ

ä½¿ç”¨goè¯­è¨€å‘é€getè¯·æ±‚ï¼Œåªéœ€è¦ä¼ å…¥URLå‚æ•°å°±è¡Œäº†ï¼Œè¦é¢„å…ˆå†™å¥½è¯·æ±‚å‚æ•°ã€‚

```go
package main

func main(){
	resp, err := http.Get("http://127.0.0.1:3000/getData")
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()
	body, err := ioutil.ReadAll(resp.Body)
    if err != nil {
		panic(err)
	}
	fmt.Printf("%T -> %v",body,body)
    //[]uint8 -> [104 101 108 108 111 32 115 101 114 118 101 114 32 114 117 110 32 98 121 32 71 79 32]
	fmt.Println(string(body))
}
```

#### resp.Body

è¯·æ±‚è¿”å›çš„å“åº”ä½“ï¼Œæ˜¯ä¸€ä¸ªå®ç°äº†`Reader`æ¥å£çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`ReadAll`è¯»å–å­—èŠ‚æ•°ç»„å†…å®¹ï¼Œè¯»å–å®Œä¸€å®šè¦å…³é—­ã€‚

```go
defer resp.Body.Close()
```

### æ·»åŠ  query å‚æ•°ğŸ”Œ

#### ParseRequestURI

è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªURLç»“æ„ä½“ï¼Œå¦‚æœä¼ å…¥URLæ ¼å¼ä¸å¯¹çš„è¯ä¼šæŠ¥é”™ã€‚

###### æºä»£ç 

```go
func ParseRequestURI(rawurl string) (*URL, error) {
	url, err := parse(rawurl, true)
	if err != nil {
		return nil, &Error{"parse", rawurl, err}
	}
	return url, nil
}
```

###### URLç»“æ„ä½“æ ¼å¼

```go
type URL struct {
	Scheme     string    // no use
	Opaque     string    // no use
	User       *Userinfo // no use
    RawPath    string    // no use
    Fragment   string    // fragment for references, without '#'	no use
    ForceQuery bool      // append a query ('?') even if RawQuery is empty   no use
    //usefull
	Host       string    // host or host:port
	Path       string    // pathname without query
	RawQuery   string    // encoded query values, without '? like 'id=1&love=1
}
```

###### Stringæ–¹æ³•

```go
func (u *URL) String() string
```

###### Queryæ–¹æ³•

```go
func (u *URL) Query() Values {   v, _ := ParseQuery(u.RawQuery)   return v}
```

> è¿”å›çš„æ˜¯ä¸€ä¸ªurl.Valueså¯ä»¥è°ƒç”¨getå’Œsetæ–¹æ³•

#### url.Values{}

###### å£°æ˜

```go
data := url.Values{}
```

> å…¶å®æ˜¯ä¸€ä¸ªç±»å‹åˆ«å
>
> - type Values map[string][]string

###### Setæ–¹æ³•

```go
func (v Values) Set(key, value string) {
	v[key] = []string{value}
}
```

###### Addæ–¹æ³•

```go
func (v Values) Add(key, value string) {
	v[key] = append(v[key], value)
}
```

###### Encodeæ–¹æ³•

```go
func (v Values) Encode() string
```

###### å®ç°æ·»åŠ å‚æ•°

```go
package main

func main(){
	apiUrl := "http://127.0.0.1:8888/getData?"
	u, err := url.ParseRequestURI(apiUrl)
	if err != nil {
		fmt.Printf("parse url requestUrl failed,err:%v\n", err)
	}
    //è·å–URLç»“æ„ä½“
	data := url.Values{}		//type Values map[string][]string
    //å£°æ˜ä¸€ä¸ªè¯·æ±‚å‚æ•°map
	data.Set("name","jack")
	data.Set("age","7")
    data.Set("age","8")
    //8ä¼šæŠŠ7é¡¶æ‰ã€‚
    data.Add("age","7")
	//ä½¿ç”¨Addæ–¹æ³•æ·»åŠ æ•°ç»„
	u.RawQuery = data.Encode()
    //å°†è¯·æ±‚å­—æ®µå’ŒURLè¿›è¡Œæ‹¼æ¥
	resp, err := http.Get(u.String())
	//è°ƒç”¨URLå¯¹è±¡çš„Stringæ–¹æ³•è¿”å›urlå­—ç¬¦ä¸²
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()
	b, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		panic(err)
	}
	fmt.Println(string(b))
}
```

[è§£ææ•ˆæœ]()

```json
{ age: [ '7', '71' ], name: 'jack' }
```



## å‘é€POSTè¯·æ±‚ ğŸ“«

### http.PostğŸ›¸

http.Postæœ‰ä¸‰ä¸ªè¯·æ±‚å‚æ•°åˆ†åˆ«æ˜¯urlï¼Œcontent-Type å’Œ io.Readeræ¥å£å®ç°è€…

```go
package main

func main() {
	url := "http://127.0.0.1:3000/postData?id=1"
	contentType := "application/json"
	data := `{"name":"å°ç‹å­",age:18}`
	resp, err := http.Post(url,contentType,strings.NewReader(data))
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()
	b, err := ioutil.ReadAll(resp.Body)
	fmt.Println(string(b))
}

```

#### resp.Body

è¯·æ±‚è¿”å›çš„å“åº”ä½“ï¼Œæ˜¯ä¸€ä¸ªå®ç°äº†`Reader`æ¥å£çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`ReadAll`è¯»å–å­—èŠ‚æ•°ç»„å†…å®¹ï¼Œè¯»å–å®Œä¸€å®šè¦å…³é—­ã€‚

```go
defer resp.Body.Close()
```

#### æ·»åŠ è¯·æ±‚ä½“ğŸ“‹

##### Post

è¿™é‡Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®è¯·æ±‚ä½“`ï¼ˆio.Readerï¼‰`å¡«å†™`Content-Type`å°±è¡Œäº†ã€‚

```go
func Post(url, contentType string, body io.Reader) (resp *Response, err error) {
	return DefaultClient.Post(url, contentType, body)
}
```

##### è¡¨å•æ•°æ®

```go
func main() {
	url := "http://127.0.0.1:3000/postData?id=1"

	// è¡¨å•æ•°æ®
	contentType := "application/x-www-form-urlencoded"
	data := "name=å°ç‹å­&age=18"

	resp, err := http.Post(url,contentType,br)

	if err != nil {
		panic(err)
	}

	defer resp.Body.Close()
	b, err := ioutil.ReadAll(resp.Body)

	fmt.Println(string(b))
}

```

##### JSONæ•°æ®

```go
func main() {
	url := "http://127.0.0.1:3000/postData?id=1"
	contentType := "application/json"
	data := `{"name":"å°ç‹å­",age:18}`
	resp, err := http.Post(url,contentType,strings.Newreader(data))
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()
	b, err := ioutil.ReadAll(resp.Body)
	fmt.Println(string(b))
}

```

##### å…¶ä»–åª’ä½“ç±»å‹ï¼ˆimg/avi/MP4*æ–‡ä»¶ï¼‰

```go
package main

func readFileWithBufio(path string) io.Reader {
	fr, err := os.Open(path)
	if err != nil {
		panic(err)
	}
	br := bufio.NewReader(fr)
	return br
}

func main() {
	url := "http://127.0.0.1:3000/postData?id=1"
	contentType := "image/jpeg"
	br := readFileWithBufio("121.jpg")
	resp, err := http.Post(url,contentType,br)
	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()
	b, err := ioutil.ReadAll(resp.Body)
	fmt.Println(string(b))
}

```

### æ·»åŠ  query å‚æ•°ğŸ”Œ

> åŒä¸Š

## Clientå‘é€æœ‰è¯·æ±‚å¤´çš„è¯·æ±‚ğŸ“¤

http.Clientå’Œhttp.NewRequestæ¥æ¨¡æ‹Ÿè¯·æ±‚

```go
package main

func main() {
    client := &http.Client{}//å®¢æˆ·ç«¯,è¢«Get,Headä»¥åŠPostä½¿ç”¨
    reqest, err := http.NewRequest("POST", "http://xxx.com/logindo", nil)
    if err != nil {
        fmt.Println("Fatal error ", err.Error())
    }
    reqest.Header.Set("Content-Type", "application/x-www-form-urlencoded;param=value") 
    //å¿…é¡»è®¾å®šè¯¥å‚æ•°,POSTå‚æ•°æ‰èƒ½æ­£å¸¸æäº¤
    resp, err := client.Do(reqest)
    //å‘é€è¯·æ±‚
    defer resp.Body.Close()
    //ä¸€å®šè¦å…³é—­resp.Body
    content, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        fmt.Println("Fatal error ", err.Error())
    }
    fmt.Println(string(content))
}
```

### type [Client](https://go-zh.org/src/net/http/client.go?s=897:2420#L26)

```go
type Client struct {
    Transport RoundTripper
    CheckRedirect func(req *Request, via []*Request) error
    Jar CookieJar
    Timeout time.Duration
}
```

åˆ›å»ºä¸€ä¸ªHttpå®¢æˆ·ç«¯ï¼Œåªèƒ½å‘é€Get,Headä»¥åŠPostè¯·æ±‚ã€‚

#### func (*Client) [Do](https://go-zh.org/src/net/http/client.go?s=6009:6070#L163)

```go
func (c *Client) Do(req *Request) (resp *Response, err error)
```

ä½¿ç”¨å®¢æˆ·ç«¯ç±»å‹å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚

#### func (*Client) [Get](https://go-zh.org/src/net/http/client.go?s=9726:9786#L285)

```go
func (c *Client) Get(url string) (resp *Response, err error)
```

ä½¿ç”¨å®¢æˆ·ç«¯å‘é€GETè¯·æ±‚

#### func (*Client) [Head](https://go-zh.org/src/net/http/client.go?s=15627:15688#L493)

```go
func (c *Client) Head(url string) (resp *Response, err error)
```

ä½¿ç”¨å®¢æˆ·ç«¯å‘é€Headè¯·æ±‚

#### func (*Client) [Post](https://go-zh.org/src/net/http/client.go?s=13807:13901#L442)

```go
func (c *Client) Post(url string, bodyType string, body io.Reader) (resp *Response, err error)
```

ä½¿ç”¨å®¢æˆ·ç«¯å‘é€Postè¯·æ±‚

#### func (*Client) [PostForm](https://go-zh.org/src/net/http/client.go?s=14735:14817#L467)

```go
func (c *Client) PostForm(url string, data url.Values) (resp *Response, err error)
```

ä½¿ç”¨å®¢æˆ·ç«¯å‘é€Postè¡¨å•è¯·æ±‚

## åˆ›å»ºé»˜è®¤å®¢æˆ·ç«¯

```go
// http server

func sayStudent(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "Hello studentï¼")
}

func sayTeacher(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "Hello teacherï¼")
}

func main() {
	http.HandleFunc("/students", sayStudent)
    http.HandleFunc("/students", sayTeacher)
    //è·¯ç”±
	err := http.ListenAndServe(":9090", nil)
	if err != nil {
		fmt.Printf("http server failed, err:%v\n", err)
		return
	}
}
```

### æµç¨‹ï¼š

#### é¦–å…ˆè°ƒç”¨Http.HandleFunc

[æŒ‰é¡ºåºåšäº†å‡ ä»¶äº‹ï¼š]()

- è°ƒç”¨äº†DefaultServerMuxçš„HandleFunc
- è°ƒç”¨äº†DefaultServerMuxçš„Handle
- å¾€DefaultServeMuxçš„map[string]muxEntryä¸­å¢åŠ å¯¹åº”çš„handlerå’Œè·¯ç”±è§„åˆ™

#### å…¶æ¬¡è°ƒç”¨http.ListenAndServe(â€œ:8001â€, nil)

[æŒ‰é¡ºåºåšäº†å‡ ä»¶äº‹æƒ…ï¼š]()

- å®ä¾‹åŒ–Server

- è°ƒç”¨Serverçš„ListenAndServe()

- è°ƒç”¨net.Listen(â€œtcpâ€, addr)ç›‘å¬ç«¯å£

- å¯åŠ¨ä¸€ä¸ªforå¾ªç¯ï¼Œåœ¨å¾ªç¯ä½“ä¸­Acceptè¯·æ±‚

- å¯¹æ¯ä¸ªè¯·æ±‚å®ä¾‹åŒ–ä¸€ä¸ªConnï¼Œå¹¶ä¸”å¼€å¯ä¸€ä¸ªgoroutineä¸ºè¿™ä¸ªè¯·æ±‚è¿›è¡ŒæœåŠ¡go c.serve()

- è¯»å–æ¯ä¸ªè¯·æ±‚çš„å†…å®¹w, err := c.readRequest()

- åˆ¤æ–­headeræ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®handlerï¼ˆè¿™ä¸ªä¾‹å­å°±æ²¡æœ‰è®¾ç½®handlerï¼‰ï¼Œhandlerå°±è®¾ç½®ä¸ºDefaultServeMux

- è°ƒç”¨handlerçš„ServeHttp

- åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸‹é¢å°±è¿›å…¥åˆ°DefaultServerMux.ServeHttp

- æ ¹æ®requesté€‰æ‹©handlerï¼Œå¹¶ä¸”è¿›å…¥åˆ°è¿™ä¸ªhandlerçš„ServeHTTP

  - ```go
    mux.handler(r).ServeHTTP(w, r)
    ```

- é€‰æ‹©handlerï¼š
  - A åˆ¤æ–­æ˜¯å¦æœ‰è·¯ç”±èƒ½æ»¡è¶³è¿™ä¸ªrequestï¼ˆå¾ªç¯éå†ServerMuxçš„muxEntryï¼‰
  - B å¦‚æœæœ‰è·¯ç”±æ»¡è¶³ï¼Œè°ƒç”¨è¿™ä¸ªè·¯ç”±handlerçš„ServeHttp
  - C å¦‚æœæ²¡æœ‰è·¯ç”±æ»¡è¶³ï¼Œè°ƒç”¨NotFoundHandlerçš„ServeHttp

## http.Requestç»“æ„ä½“

```go
fmt.Println("Method",r.Method)
fmt.Println("URL",r.URL)
fmt.Println("Proto",r.Proto)
fmt.Println("Header",r.Header)
fmt.Println("ContentLength",r.ContentLength)
fmt.Println("Host",r.Host)
fmt.Println("Form",r.Form)
fmt.Println("PostForm",r.PostForm)
fmt.Println("RequestURI",r.RequestURI)
fmt.Println("TransferEncoding",r.TransferEncoding)
/**
    Method POST
    è¯·æ±‚æ–¹æ³•ï¼ˆå­—ç¬¦ä¸²ï¼‰
    URL /postData?id=1	
    URLç»“æ„ä½“
    Proto HTTP/1.1	
    åè®®åï¼ˆå­—ç¬¦ä¸²ï¼‰
    Header map[Accept-Encoding:[gzip] Content-Type:[image/jpeg] User-Agent:[Go-http-client/1.1]] 
    è¯·æ±‚å¤´ï¼ˆmapç±»å‹ï¼‰{type Header map[string][]string}
    ContentLength -1
    è¯·æ±‚ä½“å¤§å°
    Host 127.0.0.1:3000
    ç«¯å£å·
    Form map[]
    PostForm map[]
    RequestURI /postData?id=1
    TransferEncoding [chunked]
```

## è§£æGETè¯·æ±‚ğŸ“¨

è§£æGETè¯·æ±‚çš„`handler`ï¼ˆè·¯ç”±ï¼‰

```go
func getHandler(w http.ResponseWriter, r *http.Request) {
	defer r.Body.Close()
	data := r.URL.Query()
	fmt.Println(data.Get("name"))
	fmt.Println(data.Get("age"))
	answer := `{"status": "ok"}`
	w.Write([]byte(answer))
}
```

## è§£æPOSTè¯·æ±‚ğŸ“ 

è§£æPOSTè¯·æ±‚çš„`handler`ï¼ˆè·¯ç”±ï¼‰

```go
func postHandler(w http.ResponseWriter, r *http.Request) {
	defer r.Body.Close()
	// 1. è¯·æ±‚ç±»å‹æ˜¯application/x-www-form-urlencodedæ—¶è§£æformæ•°æ®
	r.ParseForm()
	fmt.Println(r.PostForm) // æ‰“å°formæ•°æ®
	fmt.Println(r.PostForm.Get("name"), r.PostForm.Get("age"))
	// 2. è¯·æ±‚ç±»å‹æ˜¯application/jsonæ—¶ä»r.Bodyè¯»å–æ•°æ®
	b, err := ioutil.ReadAll(r.Body)
	if err != nil {
		fmt.Println("read request.Body failed, err:%v\n", err)
		return
	}
	fmt.Println(string(b))
	answer := `{"status": "ok"}`
	w.Write([]byte(answer))
}
```

