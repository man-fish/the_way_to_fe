# bufio â€” ç¼“å­˜IOğŸ˜

![](F:\æˆ‘çš„ç¬”è®°\image\jdiasdjio.png)

bufio åŒ…å®ç°äº†ç¼“å­˜IOã€‚å®ƒåŒ…è£…äº† io.Reader å’Œ io.Writer å¯¹è±¡ï¼Œåˆ›å»ºäº†å¦å¤–çš„Readerå’ŒWriterå¯¹è±¡ï¼Œå®ƒä»¬ä¹Ÿå®ç°äº† io.Reader å’Œ io.Writer æ¥å£ï¼Œä¸è¿‡å®ƒä»¬æ˜¯æœ‰ç¼“å­˜çš„ã€‚è¯¥åŒ…åŒæ—¶ä¸ºæ–‡æœ¬I/Oæä¾›äº†ä¸€äº›ä¾¿åˆ©æ“ä½œï¼Œå¹³æ—¶ä½¿ç”¨æ—¶æˆ‘ä»¬ä¸ç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œæ˜¯é€šè¿‡ç¼“å­˜æ¥è¯»å†™ï¼Œè¿™æ ·é€Ÿåº¦æ›´å¿«ï¼Œæ•ˆç‡æ›´é«˜ã€‚



## Writer ç±»å‹å’Œæ–¹æ³•ğŸ‘˜

bufio.Writer ç»“æ„åŒ…è£…äº†ä¸€ä¸ª io.Writer å¯¹è±¡ï¼Œæä¾›ç¼“å­˜åŠŸèƒ½ï¼ŒåŒæ—¶å®ç°äº† io.Writer æ¥å£ã€‚

Writer ç»“æ„æ²¡æœ‰ä»»ä½•å¯¼å‡ºçš„å­—æ®µï¼Œç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š

```go
    type Writer struct {
        err error        // å†™è¿‡ç¨‹ä¸­é‡åˆ°çš„é”™è¯¯
        buf []byte       // ç¼“å­˜
        n   int          // å½“å‰ç¼“å­˜ä¸­çš„å­—èŠ‚æ•°
        wr  io.Writer    // åº•å±‚çš„ io.Writer å¯¹è±¡
    }
```

### å®ä¾‹åŒ–

bufio åŒ…æä¾›äº†ä¸¤ä¸ªå®ä¾‹åŒ– bufio.Writer å¯¹è±¡çš„å‡½æ•°ï¼šNewWriter å’Œ NewWriterSizeã€‚å…¶ä¸­ï¼ŒNewWriter å‡½æ•°æ˜¯è°ƒç”¨ NewWriterSize å‡½æ•°å®ç°çš„ï¼š

```go
    func NewWriter(wr io.Writer) *Writer {
        // é»˜è®¤ç¼“å­˜å¤§å°ï¼šdefaultBufSize=4096
        return NewWriterSize(wr, defaultBufSize)
    }
```

æˆ‘ä»¬çœ‹ä¸€ä¸‹ NewWriterSize çš„æºç ï¼š

```go
    func NewWriterSize(wr io.Writer, size int) *Writer {
        // å·²ç»æ˜¯ bufio.Writer ç±»å‹ï¼Œä¸”ç¼“å­˜å¤§å°ä¸å°äº sizeï¼Œåˆ™ç›´æ¥è¿”å›
        b, ok := wr.(*Writer)
        if ok && len(b.buf) >= size {
            return b
        }
        if size <= 0 {
            size = defaultBufSize
        }
        return &Writer{
            buf: make([]byte, size),
            wr:  w,
        }
    }
```

### Available å’Œ Buffered æ–¹æ³•

> Available æ–¹æ³•è·å–ç¼“å­˜ä¸­è¿˜æœªä½¿ç”¨çš„å­—èŠ‚æ•°ï¼ˆç¼“å­˜å¤§å° - å­—æ®µ n çš„å€¼ï¼‰ï¼›
>
> Buffered æ–¹æ³•è·å–å†™å…¥å½“å‰ç¼“å­˜ä¸­çš„å­—èŠ‚æ•°ï¼ˆå­—æ®µ n çš„å€¼ï¼‰ã€‚

```go
func (b *Writer) Available() int { return len(b.buf) - b.n }
func (b *Writer) Buffered() int { return b.n }
```

### Flush æ–¹æ³•

è¯¥æ–¹æ³•å°†ç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®å†™å…¥åº•å±‚çš„ io.Writer å¯¹è±¡ä¸­ã€‚ä½¿ç”¨ bufio.Writer æ—¶ï¼Œåœ¨æ‰€æœ‰çš„ Write æ“ä½œå®Œæˆä¹‹åï¼Œåº”è¯¥è°ƒç”¨ Flush æ–¹æ³•ä½¿å¾—ç¼“å­˜éƒ½å†™å…¥ io.Writer å¯¹è±¡ä¸­ã€‚

```go
func (b *Writer) Flush() error {
	if b.err != nil {
		return b.err
	}
	if b.n == 0 {
        //æ²¡æœ‰ä»¥ç¼“å­˜å­—æ®µå°±è¿”å›ã€‚
		return nil
	}
	n, err := b.wr.Write(b.buf[0:b.n])
    //å°†ä»¥ç¼“å­˜å­—æ®µå†™å…¥io.write
	if n < b.n && err == nil {
        //æ²¡å†™å…¨ï¼Œå¹¶ä¸”æ²¡æœ‰å‘ç”Ÿé”™è¯¯
		err = io.ErrShortWrite
        //ä¸å®Œå…¨å†™å…¥ã€‚
	}
	if err != nil {
		if n > 0 && n < b.n {
			copy(b.buf[0:b.n-n], b.buf[n:b.n])
		}
		b.n -= n
		b.err = err
		return err
	}
	b.n = 0
	return nil
}
```

### Bufio.Writeræœ¬èº«çš„writeæ–¹æ³•

æ ¹æ®åº•å±‚io.Writerå®ç°è€…åˆ›å»ºBufio.Writerä¹‹åè¿˜éœ€è¦å¡«å……ç¼“å­˜æ•°æ®ã€‚

```go
func (b *Writer) Write(p []byte) (nn int, err error) {
	for len(p) > b.Available() && b.err == nil {
        //å¦‚æœè¯´æ²¡æœ‰å¯å†™å…¥ç©ºé—´äº†ï¼ˆå¯å†™å…¥ç©ºé—´ä¸è¶³ã€‚ï¼‰
		var n int
		if b.Buffered() == 0 {
			// Large write, empty buffer.
			// Write directly from p to avoid copy.
			n, b.err = b.wr.Write(p)
		} else {
			n = copy(b.buf[b.n:], p)
			b.n += n
			b.Flush()
		}
		nn += n
		p = p[n:]
	}
	if b.err != nil {
		return nn, b.err
	}
	n := copy(b.buf[b.n:], p)
    //å°†æ•°æ®å†™å…¥ç¼“å­˜
	b.n += n
	nn += n
	return nn, nil
}
```

### å®ä¾‹

```go
func writeItBufio(filename string){
	f,_ := os.Create(filename)
    //æ‰“å¼€æ–‡ä»¶ï¼Œè¿”å›*fileå¯¹è±¡.
	defer f.Close()
	writer := bufio.NewWriter(f)
	defer writer.Flush()
    //å°†ç¼“å­˜ä¸­æ•°æ®å†²å…¥æ–‡ä»¶ï¼ˆè°ƒç”¨äº†fileçš„writeæ–¹æ³•ï¼‰ã€‚
	for i:=0;i<10;i++ {
		fmt.Fprintln(writer,i)
        //å‘ç¼“å­˜ä¸­å†™å…¥æ•°æ®ã€‚
	}
}
```

