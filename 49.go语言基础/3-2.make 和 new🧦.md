# make å’Œ newğŸ§¦

å½“æˆ‘ä»¬æƒ³è¦åœ¨ Go è¯­è¨€ä¸­åˆå§‹åŒ–ä¸€ä¸ªç»“æ„æ—¶ï¼Œå…¶å®ä¼šä½¿ç”¨åˆ°ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„å…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯ `make` å’Œ `new`ï¼ŒåŒæ—¶å‡ºç°ä¸¤ä¸ªç”¨äºã€åˆå§‹åŒ–ã€çš„å…³é”®å­—å¯¹äºåˆå­¦è€…æ¥è¯´å¯èƒ½ä¼šæ„Ÿåˆ°éå¸¸å›°æƒ‘ï¼Œä¸è¿‡å®ƒä»¬ä¸¤è€…æœ‰ç€å´å®Œå…¨ä¸åŒçš„ä½œç”¨ã€‚

åœ¨ Go è¯­è¨€ä¸­ï¼Œ`make` å…³é”®å­—çš„ä¸»è¦ä½œç”¨æ˜¯åˆå§‹åŒ–å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢æåˆ°çš„ [æ•°ç»„å’Œåˆ‡ç‰‡](https://draveness.me/golang/datastructure/golang-array-and-slice.html)ã€[å“ˆå¸Œè¡¨](https://draveness.me/golang/datastructure/golang-hashmap.html) å’Œ [Channel](https://draveness.me/golang/concurrency/golang-channel.html)ï¼Œè€Œå½“æˆ‘ä»¬æƒ³è¦è·å–æŒ‡å‘æŸä¸ªç±»å‹çš„æŒ‡é’ˆæ—¶å…¶å®å¯ä»¥ä½¿ç”¨ `new` å…³é”®å­—ï¼Œåªæ˜¯çŸ¥é“å¦‚ä½•ä½¿ç”¨ `new` çš„äººçœŸçš„æ¯”è¾ƒå°‘ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸€èŠ‚ä¸­å°±ä¼šä»‹ç» `make` å’Œ `new` å®ƒä»¬çš„åŒºåˆ«ä»¥åŠå®ç°åŸç†ã€‚

## 0.å®é™…ä½¿ç”¨

### makeå’Œnewçš„åŒºåˆ«

> - makeå’Œnewéƒ½æ˜¯ç”¨æ¥ç”³è¯·å‚¨å­˜ç©ºé—´çš„
> - newä¸€èˆ¬å¾ˆå°‘ç”¨ï¼Œyä¸€èˆ¬ç”¨æ¥ç»™åŸºæœ¬æ•°æ®ç±»å‹ç”³è¯·å†…å­˜ç©ºé—´ï¼Œè¿”å›çš„æ˜¯å¯¹åº”ç±»å‹çš„æŒ‡é’ˆã€‚
> - makeåªèƒ½ç”¨æ¥ç»™sliceã€mapã€chanç”³è¯·å†…å­˜ç©ºé—´è¿”å›çš„æ˜¯è¿™ä¸‰ç§å¯¹è±¡æœ¬èº«ï¼Œå› ä¸ºä¸‰ä¸ªéƒ½æ˜¯å¼•ç”¨ç±»å‹å°±æ²¡æœ‰è¿”å›æŒ‡é’ˆã€‚

##### new

```go
var a1 *int
fmt.Println(a1)
var a2 = new(int)
fmt.Println(a2)
//<nil>
//0xc00000a0d8
```

##### make

```go
b := make([]int,5,10)
c := make(map[string]int,10)
fmt.Println(b)
fmt.Print(c)
//[0 0 0 0 0]
//map[]
```



## 1. æ¦‚è¿°

è™½ç„¶ `make` å’Œ `new` éƒ½æ˜¯èƒ½å¤Ÿç”¨äºåˆå§‹åŒ–æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å®ƒä»¬ä¸¤è€…èƒ½å¤Ÿåˆå§‹åŒ–çš„ç»“æ„ç±»å‹å´æœ‰ç€è¾ƒå¤§çš„ä¸åŒï¼›`make` åœ¨ Go è¯­è¨€ä¸­åªèƒ½ç”¨äºåˆå§‹åŒ–è¯­è¨€ä¸­çš„åŸºæœ¬ç±»å‹ï¼š

```go
slice := make([]int, 0, 100)
hash := make(map[int]bool, 10)
ch := make(chan int, 5)
```

è¿™äº›åŸºæœ¬ç±»å‹éƒ½æ˜¯è¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„ç« èŠ‚ä¸­å…¶å®å·²ç»ä»‹ç»è¿‡äº†å®ƒä»¬åˆå§‹åŒ–çš„è¿‡ç¨‹ä»¥åŠåŸç†ï¼Œä½†æ˜¯åœ¨è¿™é‡Œè¿˜æ˜¯éœ€è¦æé†’å„ä½è¯»è€…æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸‰è€…è¿”å›äº†ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„ï¼š

1. `slice` æ˜¯ä¸€ä¸ªåŒ…å« `data`ã€`cap` å’Œ `len` çš„**ç»“æ„ä½“**ï¼›
2. `hash` æ˜¯ä¸€ä¸ªæŒ‡å‘ `hmap` ç»“æ„ä½“çš„**æŒ‡é’ˆ**ï¼›
3. `ch` æ˜¯ä¸€ä¸ªæŒ‡å‘ `hchan` ç»“æ„ä½“çš„**æŒ‡é’ˆ**ï¼›

è€Œå¦ä¸€ä¸ªç”¨äºåˆå§‹åŒ–æ•°æ®ç»“æ„çš„å…³é”®å­— `new` çš„ä½œç”¨å…¶å®å°±éå¸¸ç®€å•äº†ï¼Œå®ƒåªæ˜¯æ¥æ”¶ä¸€ä¸ªç±»å‹ä½œä¸ºå‚æ•°ç„¶åè¿”å›ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªç±»å‹çš„æŒ‡é’ˆï¼š

```go
i := new(int)

var v int
i := &v
```

ä¸Šè¿°ä»£ç ç‰‡æ®µä¸­çš„ä¸¤ç§ä¸åŒåˆå§‹åŒ–æ–¹æ³•å…¶å®æ˜¯ç­‰ä»·çš„ï¼Œå®ƒä»¬éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å‘ `int` é›¶å€¼çš„æŒ‡é’ˆã€‚

![golang-make-and-new](https://img.draveness.me/golang-make-and-new.png)

åˆ°äº†è¿™é‡Œæˆ‘ä»¬å¯¹ Go è¯­è¨€ä¸­è¿™ä¸¤ç§ä¸åŒå…³é”®å­—çš„ä½¿ç”¨ä¹Ÿæœ‰äº†ä¸€å®šçš„äº†è§£ï¼š`make` ç”¨äºåˆ›å»ºåˆ‡ç‰‡ã€å“ˆå¸Œè¡¨å’Œç®¡é“ç­‰å†…ç½®æ•°æ®ç»“æ„ï¼Œ`new` ç”¨äºåˆ†é…å¹¶åˆ›å»ºä¸€ä¸ªæŒ‡å‘å¯¹åº”ç±»å‹çš„æŒ‡é’ˆã€‚

## 2. å®ç°åŸç†

æ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç» `make` å’Œ `new` åœ¨åˆå§‹åŒ–ä¸åŒæ•°æ®ç»“æ„æ—¶çš„å…·ä½“è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¼šä»ç¼–è¯‘æœŸé—´å’Œè¿è¡Œæ—¶ä¸¤ä¸ªä¸åŒçš„é˜¶æ®µç†è§£è¿™ä¸¤ä¸ªå…³é”®å­—çš„åŸç†ï¼Œä¸è¿‡ç”±äºå‰é¢å·²ç»è¯¦ç»†åœ°ä»‹ç»è¿‡ `make` çš„å®ç°åŸç†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå°†é‡ç‚¹æ”¾åœ¨ `new` ä¸Šä» Go è¯­è¨€çš„æºä»£ç å±‚é¢åˆ†æå®ƒçš„å®ç°ã€‚

### 2.1. make

åœ¨å‰é¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬å…¶å®å·²ç»è°ˆåˆ°è¿‡ `make` åœ¨åˆ›å»º [æ•°ç»„å’Œåˆ‡ç‰‡](https://draveness.me/golang/datastructure/golang-array-and-slice.html)ã€[å“ˆå¸Œè¡¨](https://draveness.me/golang/datastructure/golang-hashmap.html) å’Œ [Channel](https://draveness.me/golang/concurrency/golang-channel.html) çš„å…·ä½“è¿‡ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿåªæ˜¯ä¼šç®€å•æåŠ `make` ç›¸å…³çš„æ•°æ®ç»“æ„åˆå§‹åŒ–åŸç†ã€‚

![golang-make-typecheck](https://img.draveness.me/golang-make-typecheck.png)

åœ¨ç¼–è¯‘æœŸé—´çš„ [ç±»å‹æ£€æŸ¥](https://draveness.me/golang/compile/golang-typecheck.html) é˜¶æ®µï¼ŒGo è¯­è¨€å…¶å®å°±å°†ä»£è¡¨ `make` å…³é”®å­—çš„ `OMAKE` èŠ‚ç‚¹æ ¹æ®å‚æ•°ç±»å‹çš„ä¸åŒè½¬æ¢æˆäº† `OMAKESLICE`ã€`OMAKEMAP` å’Œ `OMAKECHAN` ä¸‰ç§ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹æœ€ç»ˆä¹Ÿä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°æ¥åˆå§‹åŒ–æ•°æ®ç»“æ„ã€‚

### 2.2. new

å†…ç½®å‡½æ•° `new` ä¼šåœ¨ç¼–è¯‘æœŸé—´çš„ [SSA ä»£ç ç”Ÿæˆ](https://draveness.me/golang/compile/golang-ir-ssa.html) é˜¶æ®µç»è¿‡ `callnew` å‡½æ•°çš„å¤„ç†ï¼Œå¦‚æœè¯·æ±‚åˆ›å»ºçš„ç±»å‹å¤§å°æ—¶ 0ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›ä¸€ä¸ªè¡¨ç¤ºç©ºæŒ‡é’ˆçš„ `zerobase` å˜é‡ï¼Œåœ¨é‡åˆ°å…¶ä»–æƒ…å†µæ—¶ä¼šå°†å…³é”®å­—è½¬æ¢æˆ `newobject`ï¼š

```go
func callnew(t *types.Type) *Node {
    if t.NotInHeap() {
        yyerror("%v is go:notinheap; heap allocation disallowed", t)
    }
    dowidth(t)

    if t.Size() == 0 {
        z := newname(Runtimepkg.Lookup("zerobase"))
        z.SetClass(PEXTERN)
        z.Type = t
        return typecheck(nod(OADDR, z, nil), ctxExpr)
    }

    fn := syslook("newobject")
    fn = substArgTypes(fn, t)
    v := mkcall1(fn, types.NewPtr(t), nil, typename(t))
    v.SetNonNil(true)
    return v
}
```

éœ€è¦æåˆ°çš„æ˜¯ï¼Œå“ªæ€•å½“å‰å˜é‡æ˜¯ä½¿ç”¨ `var` è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨è¿™ä¸€é˜¶æ®µå¯èƒ½ä¼šè¢«è½¬æ¢æˆ `newobject` çš„å‡½æ•°è°ƒç”¨å¹¶åœ¨å †ä¸Šç”³è¯·å†…å­˜ï¼š

```go
func walkstmt(n *Node) *Node {
    switch n.Op {
    case ODCL:
        v := n.Left
        if v.Class() == PAUTOHEAP {
            if prealloc[v] == nil {
                prealloc[v] = callnew(v.Type)
            }
            nn := nod(OAS, v.Name.Param.Heapaddr, prealloc[v])
            nn.SetColas(true)
            nn = typecheck(nn, ctxStmt)
            return walkstmt(nn)
        }
    case ONEW:
        if n.Esc == EscNone {
            r := temp(n.Type.Elem())
            r = nod(OAS, r, nil)
            r = typecheck(r, ctxStmt)
            init.Append(r)
            r = nod(OADDR, r.Left, nil)
            r = typecheck(r, ctxExpr)
            n = r
        } else {
            n = callnew(n.Type.Elem())
        }
    }
}
```

å½“ç„¶è¿™ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œå¦‚æœå½“å‰å£°æ˜çš„å˜é‡æˆ–è€…å‚æ•°ä¸éœ€è¦åœ¨å½“å‰ä½œç”¨åŸŸå¤–ã€ç”Ÿå­˜ã€ï¼Œé‚£ä¹ˆå…¶å®å°±ä¸ä¼šè¢«åˆå§‹åŒ–åœ¨å †ä¸Šï¼Œè€Œæ˜¯ä¼šåˆå§‹åŒ–åœ¨å½“å‰å‡½æ•°çš„æ ˆä¸­å¹¶éšç€ [å‡½æ•°è°ƒç”¨](https://draveness.me/golang/basic/golang-function-call.html) çš„ç»“æŸè€Œè¢«é”€æ¯ã€‚

`newobject` å‡½æ•°çš„å·¥ä½œå°±æ˜¯è·å–ä¼ å…¥ç±»å‹çš„å¤§å°å¹¶è°ƒç”¨ `mallocgc` åœ¨å †ä¸Šç”³è¯·ä¸€ç‰‡å¤§å°åˆé€‚çš„å†…å­˜ç©ºé—´å¹¶è¿”å›æŒ‡å‘è¿™ç‰‡å†…å­˜ç©ºé—´çš„æŒ‡é’ˆï¼š

```go
func newobject(typ *_type) unsafe.Pointer {
    return mallocgc(typ.size, typ, true)
}
```

`mallocgc` å‡½æ•°çš„å®ç°å¤§æ¦‚æœ‰ 200 å¤šè¡Œä»£ç ï¼Œåœ¨è¿™ä¸€èŠ‚ä¸­å°±ä¸å±•å¼€è¯¦ç»†åˆ†æäº†ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢çš„ç« èŠ‚ä¸­è¯¦ç»†ä»‹ç» Go è¯­è¨€çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€‚

## 3. æ€»ç»“

åˆ°äº†æœ€åï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ Go è¯­è¨€ä¸­ `make` å’Œ `new` å…³é”®å­—çš„å®ç°åŸç†ï¼Œ`make` å…³é”®å­—çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºåˆ‡ç‰‡ã€å“ˆå¸Œè¡¨å’Œ Channel ç­‰å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œè€Œ `new` çš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºç±»å‹ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œå¹¶è¿”å›æŒ‡å‘è¿™ç‰‡å†…å­˜çš„æŒ‡é’ˆã€‚