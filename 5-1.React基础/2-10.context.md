# Context

`Context` æä¾›äº†ä¸€ä¸ªæ— éœ€ä¸ºæ¯å±‚ç»„ä»¶æ‰‹åŠ¨æ·»åŠ  `props`ï¼Œå°±èƒ½åœ¨ç»„ä»¶æ ‘é—´è¿›è¡Œæ•°æ®ä¼ é€’çš„æ–¹æ³•ã€‚åœ¨ä¸€ä¸ªå…¸å‹çš„ `React` åº”ç”¨ä¸­ï¼Œæ•°æ®æ˜¯é€šè¿‡ `props` å±æ€§è‡ªä¸Šè€Œä¸‹ï¼ˆç”±çˆ¶åŠå­ï¼‰è¿›è¡Œä¼ é€’çš„ï¼Œä½†è¿™ç§åšæ³•å¯¹äºæŸäº›ç±»å‹çš„å±æ€§è€Œè¨€æ˜¯æå…¶ç¹ççš„ï¼ˆä¾‹å¦‚ï¼šåœ°åŒºåå¥½ï¼Œ`UI` ä¸»é¢˜ï¼‰ï¼Œè¿™äº›å±æ€§æ˜¯åº”ç”¨ç¨‹åºä¸­è®¸å¤šç»„ä»¶éƒ½éœ€è¦çš„ã€‚

![image-20201223090529096](assets/image-20201223090529096.png) 

`Context` æä¾›äº†ä¸€ç§åœ¨ç»„ä»¶ä¹‹é—´å…±äº«æ­¤ç±»å€¼çš„æ–¹å¼ï¼Œè€Œä¸å¿…æ˜¾å¼åœ°é€šè¿‡ç»„ä»¶æ ‘çš„é€å±‚ä¼ é€’ `props`ã€‚

#### ä½¿ç”¨åœºæ™¯

`Context` è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†å…±äº«é‚£äº›å¯¹äºä¸€ä¸ªç»„ä»¶æ ‘è€Œè¨€æ˜¯â€œå…¨å±€â€çš„æ•°æ®ï¼Œä¾‹å¦‚å½“å‰è®¤è¯çš„ç”¨æˆ·ã€ä¸»é¢˜æˆ–é¦–é€‰è¯­è¨€ã€‚

```jsx
class App extends React.Component {
  render() {
    return <Toolbar theme="dark" />;
  }
}

function Toolbar(props) {

  return (    
    <div>
      <ThemedButton theme={props.theme} />
    </div>  );
}

class ThemedButton extends React.Component {
  render() {
    return <Button theme={this.props.theme} />;
  }
}
```

ä½¿ç”¨ `context`, æˆ‘ä»¬å¯ä»¥é¿å…é€šè¿‡ä¸­é—´å…ƒç´ ä¼ é€’ `props`ï¼š

```jsx
// Context å¯ä»¥è®©æˆ‘ä»¬æ— é¡»æ˜ç¡®åœ°ä¼ éæ¯ä¸€ä¸ªç»„ä»¶ï¼Œå°±èƒ½å°†å€¼æ·±å…¥ä¼ é€’è¿›ç»„ä»¶æ ‘ã€‚
// ä¸ºå½“å‰çš„ theme åˆ›å»ºä¸€ä¸ª contextï¼ˆâ€œlightâ€ä¸ºé»˜è®¤å€¼ï¼‰ã€‚
const ThemeContext = React.createContext('light');
class App extends React.Component {
  render() {
    // ä½¿ç”¨ä¸€ä¸ª Provider æ¥å°†å½“å‰çš„ theme ä¼ é€’ç»™ä»¥ä¸‹çš„ç»„ä»¶æ ‘ã€‚
    // æ— è®ºå¤šæ·±ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½è¯»å–è¿™ä¸ªå€¼ã€‚
    // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† â€œdarkâ€ ä½œä¸ºå½“å‰çš„å€¼ä¼ é€’ä¸‹å»ã€‚
    return (
      <ThemeContext.Provider value="dark">
        <Toolbar />
      </ThemeContext.Provider>
    );
  }
}

class ThemedButton extends React.Component {
  static contextType = ThemeContext;
  render() {
    return <Button theme={this.context} />;
  }
}
```

#### React.createContext

åˆ›å»ºä¸€ä¸ª Context å¯¹è±¡ã€‚å½“ React æ¸²æŸ“ä¸€ä¸ªè®¢é˜…äº†è¿™ä¸ª Context å¯¹è±¡çš„ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶ä¼šä»ç»„ä»¶æ ‘ä¸­ç¦»è‡ªèº«æœ€è¿‘çš„é‚£ä¸ªåŒ¹é…çš„ `Provider` ä¸­è¯»å–åˆ°å½“å‰çš„ context å€¼ã€‚

```tsx
function createContext<T>(defaultValue: T): Context<T>;
```

**åªæœ‰**å½“ç»„ä»¶æ‰€å¤„çš„æ ‘ä¸­æ²¡æœ‰åŒ¹é…åˆ° Provider æ—¶ï¼Œå…¶ `defaultValue` å‚æ•°æ‰ä¼šç”Ÿæ•ˆã€‚è¿™æœ‰åŠ©äºåœ¨ä¸ä½¿ç”¨ Provider åŒ…è£…ç»„ä»¶çš„æƒ…å†µä¸‹å¯¹ç»„ä»¶è¿›è¡Œæµ‹è¯•ã€‚æ³¨æ„ï¼šå°† `undefined` ä¼ é€’ç»™ Provider çš„ value æ—¶ï¼Œæ¶ˆè´¹ç»„ä»¶çš„ `defaultValue` ä¸ä¼šç”Ÿæ•ˆã€‚

```tsx
interface ITabsContext {
    index?: number;
}

export const TabsContext = createContext<ITabsContext>({ index: 0 });
```

#### Context.Provider

æ¯ä¸ª `Context` å¯¹è±¡éƒ½ä¼šè¿”å›ä¸€ä¸ª `Provider React` ç»„ä»¶ï¼Œå®ƒå…è®¸æ¶ˆè´¹ç»„ä»¶è®¢é˜… `context` çš„å˜åŒ–ã€‚

```tsx
<MyContext.Provider value={/* T */}>
```

`Provider` æ¥æ”¶ä¸€ä¸ª `value` å±æ€§ï¼Œä¼ é€’ç»™æ¶ˆè´¹ç»„ä»¶ã€‚ä¸€ä¸ª `Provider` å¯ä»¥å’Œå¤šä¸ªæ¶ˆè´¹ç»„ä»¶æœ‰å¯¹åº”å…³ç³»ã€‚å¤šä¸ª `Provider` ä¹Ÿå¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œé‡Œå±‚çš„ä¼šè¦†ç›–å¤–å±‚çš„æ•°æ®ã€‚

é€šè¿‡æ–°æ—§å€¼æ£€æµ‹æ¥ç¡®å®šå˜åŒ–ï¼Œä½¿ç”¨äº†ä¸ [`Object.is`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is#Description) ç›¸åŒçš„ç®—æ³•ã€‚

#### Context.Consumer

ä¸€ä¸ª React ç»„ä»¶å¯ä»¥è®¢é˜… context çš„å˜æ›´ï¼Œè¿™è®©ä½ åœ¨[å‡½æ•°å¼ç»„ä»¶](https://zh-hans.reactjs.org/docs/components-and-props.html#function-and-class-components)ä¸­å¯ä»¥è®¢é˜… contextã€‚

```tsx
<MyContext.Consumer>
  {value => /* åŸºäº context å€¼è¿›è¡Œæ¸²æŸ“*/}
</MyContext.Consumer>
```

è¿™ç§æ–¹æ³•éœ€è¦ä¸€ä¸ª[å‡½æ•°ä½œä¸ºå­å…ƒç´ ï¼ˆfunction as a childï¼‰](https://zh-hans.reactjs.org/docs/render-props.html#using-props-other-than-render)ã€‚è¿™ä¸ªå‡½æ•°æ¥æ”¶å½“å‰çš„ context å€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ª React èŠ‚ç‚¹ã€‚ä¼ é€’ç»™å‡½æ•°çš„ `value` å€¼ç­‰ä»·äºç»„ä»¶æ ‘ä¸Šæ–¹ç¦»è¿™ä¸ª context æœ€è¿‘çš„ Provider æä¾›çš„ `value` å€¼ã€‚å¦‚æœæ²¡æœ‰å¯¹åº”çš„ Providerï¼Œ`value` å‚æ•°ç­‰åŒäºä¼ é€’ç»™ `createContext()` çš„ `defaultValue`ã€‚

#### Context.displayName

context å¯¹è±¡æ¥å—ä¸€ä¸ªåä¸º `displayName` çš„ propertyï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚React DevTools ä½¿ç”¨è¯¥å­—ç¬¦ä¸²æ¥ç¡®å®š context è¦æ˜¾ç¤ºçš„å†…å®¹ã€‚

ç¤ºä¾‹ï¼Œä¸‹è¿°ç»„ä»¶åœ¨ DevTools ä¸­å°†æ˜¾ç¤ºä¸º MyDisplayNameï¼š

```tsx
const MyContext = React.createContext(/* some value */);
MyContext.displayName = 'MyDisplayName';
<MyContext.Provider> // "MyDisplayName.Provider" åœ¨ DevTools ä¸­
<MyContext.Consumer> // "MyDisplayName.Consumer" åœ¨ DevTools ä¸­
```

## æ —å­ğŸŒ°

åˆ›å»ºä¸€ä¸ª `context` çš„æä¾›è€…ï¼š

```tsx
interface ITabsContext {
    index?: number;
    type?: TabsTypes;
    onSelect?: SelectCallback;
}

export const TabsContext = createContext<ITabsContext>({ index: 0 });
const Tabs: React.FC<TabsProps> = ({
    defaultIdx,
    style,
    className,
    type,
    children,
    onSelect,
}) => {
    const [curActive, setActive] = useState(defaultIdx);
    const handleSelect = (index: number) => {
        setActive(index);
        if (onSelect) onSelect(index);
    };

    const passedContext: ITabsContext = {
        index: curActive ? curActive : 0,
        type: type,
        onSelect: handleSelect,
    };

    return (
        <div className={classes} style={style} data-testid='test-tabs'>
            <TabsContext.Provider value={passedContext}>
                <div className='tabs-nav'>{renderNav()}</div>
                <div className='tabs-content'>{renderContent()}</div>
            </TabsContext.Provider>
        </div>
    );
};
```

ä½¿ç”¨ `context`ï¼š

```tsx
const TabsItem: React.FC<TabsItemProps> = ({
    index,
    disabled,
    className,
    style,
    children,
}) => {
    const context = useContext(TabsContext);

    const classes = classNames('tabs-item', className, {
        'is-disabled': disabled,
        'is-active': index === context.index,
    });

    const handleClick = () => {
        if (!disabled && context.onSelect && typeof index === 'number') {
            context.onSelect(index);
        }
    };

    return (
        <div className={classes} onClick={handleClick} style={style}>
            {children}
        </div>
    );
};
```

## æ¶ˆè´¹å¤šä¸ª Context

ç¡®ä¿ `context` å¿«é€Ÿè¿›è¡Œé‡æ¸²æŸ“ï¼Œ`React` éœ€è¦ä½¿æ¯ä¸€ä¸ª `consumers` ç»„ä»¶çš„ `context` åœ¨ç»„ä»¶æ ‘ä¸­æˆä¸ºä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ã€‚

```tsx
// Theme contextï¼Œé»˜è®¤çš„ theme æ˜¯ â€œlightâ€ å€¼
const ThemeContext = React.createContext('light');

// ç”¨æˆ·ç™»å½• context
const UserContext = React.createContext({
  name: 'Guest',
});

class App extends React.Component {
  render() {
    const {signedInUser, theme} = this.props;

    // æä¾›åˆå§‹ context å€¼çš„ App ç»„ä»¶
    return (
      <ThemeContext.Provider value={theme}>
        <UserContext.Provider value={signedInUser}>
          <Layout />
        </UserContext.Provider>
      </ThemeContext.Provider>
    );
  }
}

function Layout() {
  return (
    <div>
      <Sidebar />
      <Content />
    </div>
  );
}

// ä¸€ä¸ªç»„ä»¶å¯èƒ½ä¼šæ¶ˆè´¹å¤šä¸ª context
function Content() {
  return (
    <ThemeContext.Consumer>
      {theme => (
        <UserContext.Consumer>
          {user => (
            <ProfilePage user={user} theme={theme} />
          )}
        </UserContext.Consumer>
      )}
    </ThemeContext.Consumer>
  );
}
```

å¦‚æœä¸¤ä¸ªæˆ–è€…æ›´å¤šçš„ `context` å€¼ç»å¸¸è¢«ä¸€èµ·ä½¿ç”¨ï¼Œé‚£ä½ å¯èƒ½è¦è€ƒè™‘ä¸€ä¸‹å¦å¤–åˆ›å»ºä½ è‡ªå·±çš„æ¸²æŸ“ç»„ä»¶ï¼Œä»¥æä¾›è¿™äº›å€¼ã€‚

