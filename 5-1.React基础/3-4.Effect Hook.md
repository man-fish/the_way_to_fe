## æ¦‚è¿°

`Effect Hook` å¯ä»¥è®©ä½ åœ¨å‡½æ•°ç»„ä»¶ä¸­æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œã€‚

**React ä½•æ—¶æ‰§è¡Œ effect?** é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹å*å’Œ*æ¯æ¬¡æ›´æ–°ä¹‹åéƒ½ä¼šæ‰§è¡Œã€‚ä½ å¯èƒ½ä¼šæ›´å®¹æ˜“æ¥å— effect å‘ç”Ÿåœ¨â€œæ¸²æŸ“ä¹‹åâ€è¿™ç§æ¦‚å¿µï¼Œä¸ç”¨å†å»è€ƒè™‘â€œæŒ‚è½½â€è¿˜æ˜¯â€œæ›´æ–°â€ã€‚React ä¿è¯äº†æ¯æ¬¡è¿è¡Œ effect çš„åŒæ—¶ï¼ŒDOM éƒ½å·²ç»æ›´æ–°å®Œæ¯•ã€‚

**React ä½•æ—¶æ¸…é™¤ effectï¼Ÿ** React ä¼šåœ¨ç»„ä»¶å¸è½½çš„æ—¶å€™æ‰§è¡Œæ¸…é™¤æ“ä½œã€‚æ­£å¦‚ä¹‹å‰å­¦åˆ°çš„ï¼Œeffect åœ¨æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ React *ä¼š*åœ¨æ‰§è¡Œå½“å‰ effect ä¹‹å‰å¯¹ä¸Šä¸€ä¸ª effect è¿›è¡Œæ¸…é™¤ã€‚

```tsx
import React, { useState, useEffect } from "react";

const MyButton: React.FC = () => {
    const [count, setCount] = useState(0);

    function draw() {
        let date = new Date();
        document.title = "you waste " + date.toLocaleString() + " times";
    }

    useEffect(() => {
        let frameId = requestAnimationFrame(draw);
        return () => {
            cancelAnimationFrame(frameId);
        };
    });

    return (<button onClick={() => setCount(count + 1)}>{count} ğŸ‘</button>);
};

export default MyButton;
```

è¿™é‡Œæˆ‘ä»¬ä¸ºè®¡æ•°å™¨å¢åŠ äº†ä¸€ä¸ªå°åŠŸèƒ½ï¼šå°† `document çš„ title` è®¾ç½®ä¸ºå®æ—¶æ›´æ–°çš„æ—¶é—´ã€‚

æ•°æ®è·å–ï¼Œè®¾ç½®è®¢é˜…ä»¥åŠæ‰‹åŠ¨æ›´æ”¹ React ç»„ä»¶ä¸­çš„ DOM éƒ½å±äºå‰¯ä½œç”¨ã€‚ä¸ç®¡ä½ çŸ¥ä¸çŸ¥é“è¿™äº›æ“ä½œï¼Œæˆ–æ˜¯â€œå‰¯ä½œç”¨â€è¿™ä¸ªåå­—ï¼Œåº”è¯¥éƒ½åœ¨ç»„ä»¶ä¸­ä½¿ç”¨è¿‡å®ƒä»¬ã€‚

> **æç¤ºï¼š**ä½ å¯ä»¥æŠŠ `useEffect` Hook çœ‹åš `componentDidMount`ï¼Œ`componentDidUpdate` å’Œ `componentWillUnmount` è¿™ä¸‰ä¸ªå‡½æ•°çš„ç»„åˆã€‚

åœ¨ React ç»„ä»¶ä¸­æœ‰ä¸¤ç§å¸¸è§å‰¯ä½œç”¨æ“ä½œï¼šéœ€è¦æ¸…é™¤çš„å’Œä¸éœ€è¦æ¸…é™¤çš„ã€‚æˆ‘ä»¬æ¥æ›´ä»”ç»†åœ°çœ‹ä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚

#### æ— éœ€æ¸…é™¤çš„ effect

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åªæƒ³**åœ¨ React æ›´æ–° DOM ä¹‹åè¿è¡Œä¸€äº›é¢å¤–çš„ä»£ç ã€‚**æ¯”å¦‚å‘é€ç½‘ç»œè¯·æ±‚ï¼Œæ‰‹åŠ¨å˜æ›´ DOMï¼Œè®°å½•æ—¥å¿—ï¼Œè¿™äº›éƒ½æ˜¯å¸¸è§çš„æ— éœ€æ¸…é™¤çš„æ“ä½œã€‚å› ä¸ºæˆ‘ä»¬åœ¨æ‰§è¡Œå®Œè¿™äº›æ“ä½œä¹‹åï¼Œå°±å¯ä»¥å¿½ç•¥ä»–ä»¬äº†ã€‚

```jsx
import React, { useState, useEffect } from "react";

const MyButton: React.FC = () => {
    const [count, setCount] = useState(0);

    useEffect(() => {
        document.title = "count " + count;
    }, [count]);

    return (<button onClick={() => setCount(count + 1)}>{count} ğŸ‘</button>);
};

export default MyButton;

```

é€šè¿‡ä½¿ç”¨è¿™ä¸ª Hookå‘Šè¯‰ React ç»„ä»¶éœ€è¦åœ¨æ¸²æŸ“åæ‰§è¡ŒæŸäº›æ“ä½œã€‚React ä¼šä¿å­˜ä½ ä¼ é€’çš„å‡½æ•°`effect`ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œ DOM æ›´æ–°ä¹‹åè°ƒç”¨å®ƒã€‚åœ¨è¿™ä¸ª effect ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº† document çš„ title å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰§è¡Œæ•°æ®è·å–æˆ–è°ƒç”¨å…¶ä»–å‘½ä»¤å¼çš„ APIã€‚

> **`useEffect` ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œå—ï¼Ÿ** æ˜¯çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹å*å’Œ*æ¯æ¬¡æ›´æ–°ä¹‹åéƒ½ä¼šæ‰§è¡Œã€‚

#### éœ€è¦æ¸…é™¤çš„ effect

ä¹‹å‰ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å¦‚ä½•ä½¿ç”¨ä¸éœ€è¦æ¸…é™¤çš„å‰¯ä½œç”¨ï¼Œè¿˜æœ‰ä¸€äº›å‰¯ä½œç”¨æ˜¯éœ€è¦æ¸…é™¤çš„ã€‚ä¾‹å¦‚**è®¢é˜…å¤–éƒ¨æ•°æ®æº**ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ¸…é™¤å·¥ä½œæ˜¯éå¸¸é‡è¦çš„ï¼Œå¯ä»¥é˜²æ­¢å¼•èµ·å†…å­˜æ³„éœ²ï¼ç°åœ¨è®©æˆ‘ä»¬æ¥æ¯”è¾ƒä¸€ä¸‹å¦‚ä½•ç”¨ Class å’Œ Hook æ¥å®ç°ã€‚

```jsx
import React, { useState, useEffect } from 'react';

function FriendStatus(props) {
  const [isOnline, setIsOnline] = useState(null);

  useEffect(() => {
    function handleStatusChange(status) {
      setIsOnline(status.isOnline);
    }
    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);
    // Specify how to clean up after this effect:
    return function cleanup() {
      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);
    };
  });

  if (isOnline === null) {
    return 'Loading...';
  }
  return isOnline ? 'Online' : 'Offline';
}
```

## æ€§èƒ½ä¼˜åŒ–

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œæ¸…ç†æˆ–è€…æ‰§è¡Œ effect å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚åœ¨ class ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ `componentDidUpdate` ä¸­æ·»åŠ å¯¹ `prevProps` æˆ– `prevState` çš„æ¯”è¾ƒé€»è¾‘è§£å†³ï¼š

```jsx
componentDidUpdate(prevProps, prevState) {
  if (prevState.count !== this.state.count) {
    document.title = `You clicked ${this.state.count} times`;
  }
}
```

è¿™æ˜¯å¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œæ‰€ä»¥å®ƒè¢«å†…ç½®åˆ°äº† `useEffect` çš„ Hook API ä¸­ã€‚å¦‚æœæŸäº›ç‰¹å®šå€¼åœ¨ä¸¤æ¬¡é‡æ¸²æŸ“ä¹‹é—´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½ å¯ä»¥é€šçŸ¥ React **è·³è¿‡**å¯¹ effect çš„è°ƒç”¨ï¼Œåªè¦ä¼ é€’æ•°ç»„ä½œä¸º `useEffect` çš„ç¬¬äºŒä¸ªå¯é€‰å‚æ•°å³å¯ï¼š

```jsx
useEffect(() => {
  document.title = `You clicked ${count} times`;
}, [count]); // ä»…åœ¨ count æ›´æ”¹æ—¶æ›´æ–°
```

å½“ä½ ä½ è¦æ¯”è¾ƒçš„æ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œä¸€å®šè¦ä¼ å…¥å…·ä½“çš„å±æ€§ï¼Œä¸ç„¶ä¼ å…¥æ•´ä¸ªå¯¹è±¡æ¯”è¾ƒçš„å°±æ˜¯åœ°å€ï¼š

```jsx
import React, { useState, useEffect } from "react";

const MyButton: React.FC = () => {
    const [count, setCount] = useState(0);

    useEffect(() => {
        document.title = "count " + count;
    }, [count]);

    const [user, setUser] = useState({ name: "inno" });

    useEffect(() => {
        document.title = "user " + user.name;
    }, [user.name]);

    return (
        <div>
            <button onClick={() => setUser({ name: "inno" })} > setUser </button>
            <button onClick={() => setCount(count + 1)}>{ count } ğŸ‘</button>
        </div>
    );
};
```

> **æ³¨æ„ï¼š**å¦‚æœä½ è¦ä½¿ç”¨æ­¤ä¼˜åŒ–æ–¹å¼ï¼Œè¯·ç¡®ä¿æ•°ç»„ä¸­åŒ…å«äº†**æ‰€æœ‰å¤–éƒ¨ä½œç”¨åŸŸä¸­ä¼šéšæ—¶é—´å˜åŒ–å¹¶ä¸”åœ¨ effect ä¸­ä½¿ç”¨çš„å˜é‡**ï¼Œå¦åˆ™ä½ çš„ä»£ç ä¼šå¼•ç”¨åˆ°å…ˆå‰æ¸²æŸ“ä¸­çš„æ—§å˜é‡ã€‚

## æç¤º: ä½¿ç”¨å¤šä¸ª Effect å®ç°å…³æ³¨ç‚¹åˆ†ç¦»

ä½¿ç”¨ Hook å…¶ä¸­ä¸€ä¸ª[ç›®çš„](https://zh-hans.reactjs.org/docs/hooks-intro.html#complex-components-become-hard-to-understand)å°±æ˜¯è¦è§£å†³ class ä¸­ç”Ÿå‘½å‘¨æœŸå‡½æ•°ç»å¸¸åŒ…å«ä¸ç›¸å…³çš„é€»è¾‘ï¼Œä½†åˆæŠŠç›¸å…³é€»è¾‘åˆ†ç¦»åˆ°äº†å‡ ä¸ªä¸åŒæ–¹æ³•ä¸­çš„é—®é¢˜ã€‚ä¸‹è¿°ä»£ç æ˜¯å°†å‰è¿°ç¤ºä¾‹ä¸­çš„è®¡æ•°å™¨å’Œå¥½å‹åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨é€»è¾‘ç»„åˆåœ¨ä¸€èµ·çš„ç»„ä»¶ï¼š

```jsx
function FriendStatusWithCounter(props) {
  const [count, setCount] = useState(0);
  useEffect(() => {    
    document.title = `You clicked ${count} times`;
  });

  const [isOnline, setIsOnline] = useState(null);
  useEffect(() => {    
    function handleStatusChange(status) {
      setIsOnline(status.isOnline);
    }

    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);
    return () => {
      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);
    };
  });
  // ...
}
```