## 1、生产消息

1）提供异步生产消息接口，供生产者调用。


系统消息接口所需参数：

| 参数     | 是否必须 | 参数说明       |
| :------- | :------- | :------------- |
| 接收用户 | 是       | 接收消息的用户 |
| 发送内容 | 否       | 评论的内容等   |

关注消息接口所需参数：

| 参数     | 是否必须 | 参数说明         |
| :------- | :------- | :--------------- |
| 发送用户 | 是       | 系统消息为SMSTEM |
| 接收用户 | 是       | 接收消息的用户   |



其它消息（跟动态有关）接口所需参数：

| 参数     | 是否必须 | 参数说明                                                     |
| :------- | :------- | :----------------------------------------------------------- |
| 消息类型 | 是       | 点赞、回复、打赏、@、评论                                    |
| 发送用户 | 是       | 发送者                                                       |
| 接收用户 | 是       | 接收消息的用户                                               |
| 内容     | 否       | 发送的内容                                                   |
| 资源ID   | 是       | 动态的ID                                                     |
| 对象ID   | 否       | 回复、@、评论 传评论ID，其它不传（为了处理删除情况，原消息显示评论已删除） |



**当消息类型为“评论”时，同时生产蹲消息。往蹲消息队列中生产消息。**

消息接口收到消息时通过消息模版组装消息。消息组装完成后存入redis、数据库中。 

蹲消息采用redis zset设计，蹲消息只保留一份，所有用户共享。

蹲消息图示如下：

![img](assets/image2021-2-8_15-23-46.png)

2）生产接口收到消息后，通过消息模版组装消息。组装完消息后存入redis、数据库中。

![img](assets/image2021-2-8_15-18-57.png)

消息的组装中，为保持更换头像和呢称时消息列表上能及时更新，同学头像和呢称在返回给前端接口时从用户缓存中取。动态简图和动态文字从动态缓存中取。

## 2、消息消费

|          | 消息类别                                                     | 消费逻辑描述                                                 |
| :------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| 聚合     | 被关注消息                                                   | redis zset实现（方便扩展时显示关注消息列表）。关注时往zset里添加元素。点击“被关注”聚合列表时删除 key |
| 系统消息 | 系统i消息表+redis zset实现新增系统消息时住消息表和redis里添加数据。点击“系统消息”聚合列表时删除redis key。更新数据库消息状态。系统消息表的明细页查询-分页逻辑同外层由于系统消息的已读需求是，当用户进入时会将所有消息变为已读，但是前端展示时还是分页展示未读的。所以后端在处理时，在第一次拉取消息时会将未读的zset数据复制到一个新的临时zset数据中，后续分页数据查询都从该临时zet数据中获取。当数据全部获取后，将临时缓存删除。 |                                                              |
| 蹲消息   | redis zset + hash实现（方便后期扩展时显示蹲消息列表、同时一个动态只生产一份蹲消息，多用户共享）。蹲动态时在hash中存入蹲的时间，消费时用蹲时间和当前时间去zset中取数据，取完数据后更新蹲时间。 |                                                              |
| 分页     | 其它消息(@、评论、回复、点赞、打赏)                          | 用户消息表+ redis zset实现新增消息时住消息表和redis里添加数据。拉取分页数据时从zset时删除。更新数据库消息状态。分页处理，默认200 |
| 分页     | 历史消息                                                     | 用户消息表+ redis hash实现 从hash中加载分页缓存信息，缓存为空时,从数据库中查询历史消息，然后缓存当有新历史消息进入时删除所有分页缓存 历史消息需要分页，默认20，根据ID分页 |

聚合消息如果没有未读消息，但有过已读消息，取已读消息第一条。蹲消息处理成“暂无消息”

## 3、未读消息

| 类型     | 取数逻辑                                               |
| :------- | :----------------------------------------------------- |
| 未读消息 | 计算"其它消息"中zset中消息的数量。不删除。             |
| 新消息   | 计算"其它消息"中消息时间大于拉取的最新消息的元素数量。 |

## 4、库表设计

系统消息表（system_message）

| 字段名       | 字段名称      | 字段备注      |
| :----------- | :------------ | :------------ |
| ID           | bigint(20)    | 主键          |
| RECEIVER     | char(100)     | 接收用户      |
| RELATED_USER | char(100)     | 关联用户账号  |
| CONTENT      | varchar(2000) | 消息内容      |
| STATUS       | tinyint(4)    | 0 未读 1 已读 |
| READ_TIME    | datetime      | 读取时间      |
| CREATE_TIME  | datetime      | 创建时间      |
| UPDATE_TIME  | datetime      | 更新时间      |
| VERSION      | int           | 版本          |

用户消息表（user_message）

| 字段名        | 字段名称     | 字段备注             |
| :------------ | :----------- | :------------------- |
| ID            | bigint(20)   | 主键                 |
| SENDER        | char(100)    | 发送用户             |
| RECEIVER      | char(100)    | 接收用户             |
| RELATED_USER  | char(100)    | 关联用户账号         |
| CONTENT       | varchar(128) | 消息内容(非拼接消息) |
| EXT1          | varchar(128) | 扩展字段1            |
| RESOURCE_TYPE | tinyint(4)   | 资源类型 1动态 2关注 |
| RESOURCE_ID   | bigint(20)   | 资源ID               |
| OBJECT_ID     | bigint(20)   | 对象ID               |
| STATUS        | tinyint(4)   | 0 未读 1 已读        |
| READ_TIME     | datetime     | 读取时间             |
| CREATE_TIME   | datetime     | 创建时间             |
| UPDATE_TIME   | datetime     | 更新时间             |
| VERSION       | int          | 版本                 |

系统消息表（system_message）

| 字段名       | 字段名称      | 字段备注      |
| :----------- | :------------ | :------------ |
| ID           | bigint(20)    | 主键          |
| RECEIVER     | char(100)     | 接收用户      |
| RELATED_USER | char(100)     | 关联用户账号  |
| CONTENT      | varchar(2000) | 消息内容      |
| STATUS       | tinyint(4)    | 0 未读 1 已读 |
| READ_TIME    | datetime      | 读取时间      |
| CREATE_TIME  | datetime      | 创建时间      |
| UPDATE_TIME  | datetime      | 更新时间      |
| VERSION      | int           | 版本          |